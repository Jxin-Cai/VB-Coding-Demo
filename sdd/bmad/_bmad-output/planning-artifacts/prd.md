---
stepsCompleted: [step-01-init, step-02-discovery, step-03-success, step-04-journeys, step-05-domain, step-06-innovation, step-07-project-type, step-08-scoping, step-09-functional, step-10-nonfunctional, step-11-polish]
inputDocuments:
  - planning-artifacts/product-brief-RAG-Text-to-SQL-系统-2026-01-24.md
  - doc/mvp-optimized.md
workflowType: 'prd'
briefCount: 1
researchCount: 0
brainstormingCount: 0
projectDocsCount: 1
classification:
  projectType: web_app
  domain: scientific
  complexity: medium
  projectContext: greenfield
  scale: personal_tool
date: 2026-01-24
author: Jxin
---

# Product Requirements Document - RAG Text-to-SQL 系统

**Author:** Jxin
**Date:** 2026-01-24

## Success Criteria

### User Success

**核心成功体验：5分钟内完成自助数据导出**

产品经理在使用本系统时,成功意味着:

1. **自助完成能力**
   - **目标**：≥ 80% 的数据导出无需开发协助
   - **体验**：从"依赖开发"转变为"自助完成"

2. **SQL 生成可靠性**
   - **目标**：生成的 SQL 准确率 100%
   - **体验**：用户信任系统生成的 SQL,无需频繁修正

3. **效率提升感知**
   - **目标**：数据获取时间从 30 分钟缩短到 5 分钟内
   - **体验**：6倍效率提升,工作节奏不被打断

4. **"Aha!" 时刻触达**
   - **目标**：≥ 90% 的新用户首次使用即成功生成 SQL
   - **体验**：第一次输入自然语言就看到精准的 SQL

5. **持续使用习惯**
   - **目标**：活跃用户每周使用 ≥ 3 次
   - **体验**：系统成为日常工作的常用工具

### Business Success

作为个人工具,业务成功聚焦于技术验证和实际效用:

**短期目标（3 个月）- MVP 验证阶段**
- **用户采纳**：10-20 个产品经理开始使用（团队内试用）
- **核心验证**：RAG 技术有效性验证（SQL 生成准确率 100%）
- **间接价值**：开发团队 SQL 请求减少 30%-50%

**中期目标（6-12 个月）- 功能增强阶段**
- **用户扩展**：50+ 产品经理日常使用
- **功能完善**：实现增强功能（SQL 验证、DDL 可视化等）
- **效率提升**：产品决策周期缩短 30%

**长期目标（12+ 个月）- 推广阶段**
- **规模化**：覆盖公司所有产品经理和数据分析岗位
- **标准化**：成为数据自助查询的标准工具
- **成本节约**：开发团队工作效率提升,产品决策质量提升

### Measurable Outcomes

**MVP 验收的可量化结果:**

| 指标类别 | 具体指标 | 目标值 | 验收标准 |
|---------|---------|--------|---------|
| **功能完整性** | DDL 文件解析成功率 | ≥ 90% | 用户上传文件后能看到解析结果 |
| | SQL 生成准确率 | 100% | 生成的 SQL 可直接执行 |
| | 引用源展示 | 100% | 每次生成都展示引用的表 |
| **用户体验** | 首次使用成功率 | ≥ 90% | 新用户 5 分钟内生成首条 SQL |
| | 自助完成率 | ≥ 80% | 无需开发协助完成查询 |
| | 使用频率 | ≥ 3次/周 | 活跃用户周均使用次数 |
| **技术性能** | DDL 向量化 | < 5秒 | 单文件处理时间 |
| | SQL 生成响应 | < 3秒 | 用户输入到 SQL 生成 |
| | 系统可用性 | ≥ 99.5% | 月度可用性统计 |
| **用户满意度** | 满意度评分 | ≥ 4.0/5.0 | 用户反馈评分 |
| | 留存率 | ≥ 70% | 30 天留存率 |

---

## Product Scope

### MVP - Minimum Viable Product

**核心功能（必须实现）:**

**1. DDL 文件管理模块**
- ✅ 文件上传（支持 .sql 格式）
- ✅ DDL 解析（表结构、字段、索引信息）
- ✅ 向量化存储（FAISS/Chroma 内存向量库）
- ✅ 文件管理界面（列表、状态、删除功能）

**2. 智能对话与 SQL 生成模块**
- ✅ 双模式交互（普通对话 + SQL 生成自动切换）
- ✅ Agent 架构（LLM 自主决策调用向量检索）
- ✅ RAG 流程（自然语言 → 向量检索 → SQL 生成）
- ✅ 可解释性（展示引用的表和字段）

**3. 基础技术架构**
- ✅ 前端：Vue.js 3 + Element Plus/Ant Design Vue
- ✅ 后端：Python + LangChain + LangGraph
- ✅ 向量库：FAISS/Chroma（内存）
- ✅ LLM：GLM 模型
- ✅ 架构：DDD 分层架构

**MVP 边界（明确不包含）:**
- ❌ SQL 执行和结果预览
- ❌ 多用户登录和权限管理
- ❌ 数据库直连
- ❌ SQL 语法验证
- ❌ DDL 关系图可视化

**理由**：MVP 聚焦于验证 RAG Text-to-SQL 的核心技术可行性

### Growth Features (Post-MVP)

**Phase 2: 功能增强（3-6 个月）**

1. **SQL 增强功能**
   - SQL 语法验证和错误提示
   - SQL 执行和结果预览
   - SQL 执行历史记录

2. **DDL 可视化**
   - DDL 关系图可视化
   - 表之间依赖关系分析
   - 数据字典自动生成

3. **多数据库支持**
   - 支持 MySQL, PostgreSQL, Oracle, SQL Server
   - 数据库方言自动适配

### Vision (Future)

**Phase 3: 企业级扩展（6-12 个月）**

1. **用户与权限管理**
   - 多用户登录和身份认证
   - 基于角色的权限控制（RBAC）
   - 操作审计日志

2. **数据库直连**
   - 直接连接数据库获取 DDL
   - 自动同步表结构变更
   - 支持多数据源管理

3. **高级 Agent 能力**
   - 多轮复杂推理和任务拆解
   - 自动优化查询性能
   - 自动修复常见 SQL 错误

**Phase 4: 平台化（12+ 个月）**

1. **数据分析平台**
   - 集成数据可视化功能
   - 支持数据报表自动生成
   - 数据洞察自动发现

2. **生态扩展**
   - 开放 API 供第三方集成
   - 插件机制支持自定义扩展
   - 社区共享 SQL 模板库

---

## User Journeys

### Journey 1: 产品经理 - 首次使用（"Aha!" 时刻）

**人物：李雨晴（27岁,产品经理,工作2年）**

**背景故事:**
- 负责电商平台的用户增长模块
- 每周需要3-5次从数据库导出数据分析用户行为
- 不懂SQL,每次都要找开发同学小张帮忙
- 小张很忙,经常要等半小时才回复,有时候要第二天才能拿到数据
- 李雨晴感觉很不好意思,但又没办法

**Opening Scene（痛点场景）:**

周三下午3点,李雨晴在准备周会PPT,需要"最近30天新用户的地域分布数据"。她打开企业微信,犹豫了5分钟要不要再麻烦小张...

上周小张刚帮她导了3次数据,这周已经是第2次了。她看着聊天框,不知道怎么开口。距离周会还有2小时,如果小张在忙,她可能来不及了...

**Rising Action（发现产品）:**

就在这时,她想起昨天技术主管在群里分享的"RAG Text-to-SQL 工具",说可以自助生成SQL。李雨晴抱着试一试的心态打开了系统。

**Step 1: 上传 DDL 文件**
- 她从共享文档找到了数据库DDL文件（上个月小张给她的）
- 拖拽上传到系统,界面提示"解析中..."
- 3秒后显示："✅ 成功解析 23 张表,156 个字段"
- 心想："这么快？真的可以吗？"

**Step 2: 用自然语言描述需求**
- 看到对话框,她犹豫了一下,输入：
  > "我想看最近30天新注册用户的地域分布,按省份统计人数,降序排列"
- 点击发送,心里有点忐忑："这样说能行吗？"

**Step 3: 生成 SQL（Climax - "Aha!" 时刻）**
- 2秒后,系统返回了SQL：
  ```sql
  SELECT province, COUNT(*) as user_count
  FROM users
  WHERE register_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
  GROUP BY province
  ORDER BY user_count DESC;
  ```
- 下方还显示了引用信息：
  > 📋 **引用来源**：
  > - 表：users（用户表）
  > - 字段：province（省份）、register_time（注册时间）

**Step 4: 第一次自助完成（Resolution）**
- 李雨晴眼睛亮了："就是这个！"
- 她把SQL复制给小张,附上一句："帮我跑一下这个SQL就行～"
- 小张1分钟就回复了数据
- **总耗时：从犹豫到拿到数据,5分钟！**

**情感转变:**
- **Before**：焦虑、不好意思、被动等待、工作被阻塞
- **After**：惊喜、自信、主动掌控、工作流畅

**新现实:**
李雨晴兴奋地把工具分享给了同组的产品经理,她说："以后再也不用等开发了！我现在可以自己搞定SQL！"

---

### Journey 2: 产品经理 - 日常高频使用

**人物：王浩（30岁,产品经理,工作5年）**

**背景故事:**
- 负责B2B SaaS产品的数据分析
- 已经使用这个工具1个月,非常熟练
- 每周用3-5次,主要是早会前快速导数据

**Opening Scene（日常场景）:**

周一早上9:30,距离10点的周会还有30分钟。王浩需要准备3个数据：
1. 上周新增客户数（按行业分组）
2. 上周活跃客户TOP 10
3. 上周流失客户及流失原因

以前这需要找开发,现在他打开了熟悉的系统界面。

**Rising Action（连续生成 SQL）:**

**第1个需求：新增客户统计**
- 输入："上周新增客户,按行业分组统计"
- 3秒生成SQL,复制
- 引用：customers表（industry, create_time字段）

**第2个需求：活跃客户排行**
- 输入："上周活跃客户TOP 10,按登录次数排序"
- 2秒生成SQL,复制
- 引用：user_activity表（login_count, last_login字段）

**第3个需求：流失客户分析**
- 输入："上周流失的客户名单,包含流失原因"
- 3秒生成SQL,复制
- 引用：customers表（churn_reason, churn_date字段）

**Climax（高效完成）:**
- **总耗时：8分钟完成3个SQL**
- 9:38 发给开发小李："帮我跑一下这3个SQL～"
- 9:50 拿到所有数据,整理完PPT
- 10:00 从容走进会议室

**情感转变:**
- **Before（用工具前）**：焦虑、时间紧张、可能开会没数据
- **After（现在）**：从容、高效、工作掌控感

**Resolution（新现实）:**
王浩现在养成了习惯：每周五下午提前准备好下周的SQL,周一早上直接发给开发跑数据。他的工作节奏完全改变了。

---

### Journey 3: 产品经理 - 文件管理

**人物：张敏（29岁,产品经理,负责多个项目）**

**背景故事:**
- 同时负责3个项目：电商主站、小程序、供应链系统
- 每个项目用不同的数据库
- 需要管理多个DDL文件和未来可能的数据字典文件

**Opening Scene（文件管理场景）:**

周四下午,张敏需要给新来的产品实习生讲解电商主站的数据表结构。她打开系统的"文件管理"页面：

```
📁 我的文件
├─ 电商主站_DDL_v2.3.sql (已解析 ✅) - 上传于 2026-01-15
├─ 小程序_DDL_v1.8.sql (已解析 ✅) - 上传于 2026-01-10  
├─ 供应链_DDL_v3.0.sql (解析中 ⏳) - 上传于 2026-01-24
└─ 数据字典_电商主站.xlsx (待支持 ⚠️) - 上传于 2026-01-23
```

**Rising Action（文件操作）:**

**场景1：切换项目上下文**
- 上午在分析电商数据,使用"电商主站_DDL"
- 下午要分析小程序数据,点击"小程序_DDL"
- 系统自动切换向量库上下文
- 生成的SQL自动参考小程序的表结构

**场景2：更新DDL文件**
- 开发更新了电商主站的表结构
- 张敏上传新版本"电商主站_DDL_v2.4.sql"
- 系统提示："检测到同名文件,是否覆盖？"
- 选择覆盖,旧版本自动归档

**场景3：发现不支持的文件**
- 看到"数据字典_电商主站.xlsx"显示"待支持"
- 系统提示："当前仅支持.sql文件,Excel数据字典支持将在未来版本提供"
- 心想："没关系,至少SQL文件够用了"

**Climax（文件管理的价值）:**
- 多项目切换清晰明了
- 文件状态一目了然
- 版本管理简单有效

**情感转变:**
- **Before**：混乱、找不到文件、不知道哪个是最新版
- **After**：清晰、有条理、放心使用

---

### Journey 4: 数据分析师 - 辅助提效

**人物：陈亮（32岁,数据分析师,工作8年）**

**背景故事:**
- 精通SQL,每天写10+个查询
- 经常需要写复杂的JOIN、子查询、窗口函数
- 痛点：基础SQL结构写起来很繁琐,特别是多表JOIN时要反复查DDL

**Opening Scene（辅助提效场景）:**

周五下午,陈亮需要分析"用户购买行为与营销活动效果",需要关联5张表：
- users（用户表）
- orders（订单表）
- order_items（订单明细表）
- campaigns（营销活动表）
- campaign_users（用户参与活动表）

**传统方式的痛苦:**
- 需要打开DDL文件,找每张表的主键、外键
- 手写JOIN条件,经常写错字段名
- 光是写JOIN结构就要10分钟

**Rising Action（使用工具加速）:**

**Step 1: 快速生成基础结构**
- 输入："关联用户表、订单表、订单明细表、营销活动表、用户参与活动表,按用户ID关联"
- 3秒生成基础SQL框架：
  ```sql
  SELECT 
    u.user_id,
    u.user_name,
    o.order_id,
    oi.product_id,
    c.campaign_name
  FROM users u
  LEFT JOIN orders o ON u.user_id = o.user_id
  LEFT JOIN order_items oi ON o.order_id = oi.order_id
  LEFT JOIN campaign_users cu ON u.user_id = cu.user_id
  LEFT JOIN campaigns c ON cu.campaign_id = c.campaign_id;
  ```

**Climax（在基础上手动完善）:**
- 陈亮看到基础框架："不错,JOIN条件都对了！"
- 他在此基础上手动添加：
  - WHERE条件（时间范围、活动类型）
  - 复杂的聚合计算（转化率、ROI）
  - 窗口函数（用户行为序列分析）
- **从10分钟 → 3分钟完成基础结构**

**Resolution（新的工作方式）:**
- 工具生成基础SQL（表关联、字段选择）
- 陈亮专注于业务逻辑（复杂计算、性能优化）
- 效率提升50%,工作重心从"写代码"转向"分析洞察"

**情感转变:**
- **Before**：繁琐、低效、把时间浪费在基础工作上
- **After**：高效、专注、把精力用在真正的分析上

---

### Journey Requirements Summary

**这些用户旅程揭示了以下核心能力需求:**

#### 1. DDL 文件管理能力
- ✅ 文件上传（拖拽、选择文件）
- ✅ 快速解析（< 5秒/文件）
- ✅ 解析结果展示（表数量、字段数量）
- ✅ 文件列表管理（名称、状态、上传时间）
- ✅ 文件状态可视化（已解析 ✅、解析中 ⏳、失败 ❌、待支持 ⚠️）
- ✅ 文件删除/覆盖功能
- ✅ 多文件管理（支持多个项目的DDL）
- ✅ 上下文切换（选择当前使用的文件）
- ✅ 扩展性设计（未来支持Excel、JSON等其他格式）

#### 2. 智能对话与 SQL 生成能力
- ✅ 自然语言输入界面（简单直观）
- ✅ 快速响应（< 3秒生成SQL）
- ✅ SQL 语法正确（可直接执行）
- ✅ 支持复杂查询（多表JOIN、聚合、排序、子查询）
- ✅ 智能识别表关联关系（主键、外键）
- ✅ 生成标准SQL结构（专业人士可修改）

#### 3. 可解释性与信任建立
- ✅ 展示引用来源（表名、字段名）
- ✅ 清晰的引用格式（表（中文说明）+ 字段（中文说明））
- ✅ 建立用户信任（透明度）

#### 4. 用户体验设计
- ✅ 首次使用引导（降低心理门槛）
- ✅ 一键复制SQL
- ✅ 多查询支持（快速切换）
- ✅ 对话历史（可选）
- ✅ 错误提示友好（文件解析失败、SQL生成失败）

#### 5. 性能与可靠性
- ✅ DDL 向量化速度（< 5秒）
- ✅ SQL 生成速度（< 3秒）
- ✅ 稳定性能（每次都要快）
- ✅ 系统可用性（≥ 99.5%）

#### 6. 适配不同用户类型
- ✅ 初学者友好（产品经理、运营）：自然语言、简单界面
- ✅ 专业人士辅助（数据分析师）：生成基础结构、可修改性

---

**旅程覆盖的场景完整性:**
- ✅ 首次使用 - Happy Path（"Aha!"时刻）
- ✅ 日常高频使用（效率提升）
- ✅ 文件管理（多项目支持）
- ✅ 专业用户辅助（扩展价值）
- ✅ 错误场景（在旅程中体现：文件解析失败、不支持的格式）

这些旅程为后续的功能需求、领域建模、技术架构提供了清晰的用户场景基础。

---

## Domain-Specific Requirements

### AI/ML 准确性与可靠性

作为一个 **Scientific 领域的 AI 应用**,本系统的核心价值在于 AI 生成的质量和可靠性。

#### 1. SQL 生成准确率要求

**核心质量标准：SQL 生成准确率必须达到 100%**

**定义:**
- **语法正确性**：生成的 SQL 必须符合目标数据库的语法规范,能够被数据库引擎成功解析和执行
- **逻辑正确性**：生成的 SQL 必须完全符合用户的自然语言意图,查询结果与用户预期完全一致
- **完整性**：生成的 SQL 必须包含所有必要的条件、关联、排序等逻辑,不遗漏任何用户要求

**实现策略:**

1. **多层验证机制**
   - **语法验证**：使用 SQL Parser（sqlparse/sqlglot）在生成后立即进行语法检查
   - **逻辑验证**：Agent 自我验证生成的 SQL 是否满足用户意图（ReAct 推理模式）
   - **引用验证**：确保引用的表和字段确实存在于 DDL 中

2. **生成策略优化**
   - **RAG 精准召回**：向量检索相关性 ≥ 85%,确保上下文完整准确
   - **Prompt 工程**：专业的数据分析专家 Persona + 明确的输出格式要求
   - **Few-shot Learning**：在 Prompt 中提供高质量示例

3. **质量保障机制**
   - **可解释性强制要求**：每次生成必须展示引用来源,便于用户验证
   - **用户反馈循环**：收集用户修正的 SQL,用于持续优化 Prompt 和检索策略
   - **测试覆盖**：针对不同类型的查询（简单查询、多表 JOIN、聚合、子查询）建立测试集

#### 2. 系统可靠性要求

**目标：确保系统稳定、一致、可预测**

1. **输出一致性**
   - **相同输入 → 相同输出**：相同的自然语言描述应生成一致的 SQL
   - **LLM 温度控制**：使用较低的 temperature（如 0.1）确保输出稳定性

2. **错误处理与降级**
   - **解析失败处理**：DDL 解析失败时,清晰提示用户错误原因和修正建议
   - **生成失败处理**：SQL 生成失败时,提供友好的错误提示和重试机制
   - **向量检索失败降级**：如果检索不到相关 DDL,明确告知用户而非生成错误的 SQL

3. **性能与资源可靠性**
   - **超时保护**：向量检索和 LLM 调用设置合理的超时时间（< 5秒）
   - **资源限制**：内存向量库的大小限制,防止系统崩溃
   - **并发控制**：LLM API 调用的并发限制和重试机制

#### 3. 验证方法论

**MVP 阶段的验证策略:**

1. **单元测试**
   - DDL 解析模块：覆盖各种 DDL 语法（建表、索引、外键等）
   - 向量检索模块：验证检索相关性和召回率
   - SQL 生成模块：测试不同类型查询的生成准确性

2. **集成测试**
   - 端到端测试：从 DDL 上传 → 自然语言输入 → SQL 生成的完整流程
   - 边界条件测试：大文件、复杂查询、多表关联

3. **用户验收测试**
   - 真实产品经理测试（10-20 人）
   - 收集生成的 SQL 是否能直接执行
   - 统计修正率（目标：0%,即无需修正）

4. **持续监控**
   - 记录每次生成的 SQL 和用户反馈
   - 统计准确率、响应时间、错误类型
   - 建立质量仪表盘

#### 4. 质量指标

**核心指标:**

| 指标 | 目标值 | 验收标准 |
|-----|-------|---------|
| SQL 生成准确率 | **100%** | 生成的 SQL 无语法错误且逻辑完全正确 |
| 向量检索相关性 | ≥ 85% | 召回的 DDL 片段与用户意图高度相关 |
| 输出一致性 | ≥ 95% | 相同输入的 SQL 输出一致性 |
| SQL 生成响应时间 | < 3秒 | 用户输入到 SQL 生成的时间 |
| 系统可用性 | ≥ 99.5% | 月度可用性统计 |

**说明:**
- **100% 准确率**意味着零容忍度：任何语法错误或逻辑错误都是不可接受的
- 这要求更严格的测试覆盖、更完善的验证机制、更精细的 Prompt 工程
- MVP 阶段如果无法达到 100%,必须有明确的质量改进计划

#### 5. 风险缓解措施

**主要风险与应对策略:**

1. **风险：LLM 生成的 SQL 不稳定**
   - **缓解**：低温度采样、Few-shot 示例、强制输出格式、语法验证
   
2. **风险：RAG 召回不准确**
   - **缓解**：优化 Embedding 模型、调整 Chunk 策略、提升检索相关性阈值

3. **风险：复杂查询难以达到 100% 准确**
   - **缓解**：MVP 阶段限定支持的查询复杂度,复杂查询（如多层子查询、窗口函数）可在 Phase 2 中增强

4. **风险：用户意图描述不清晰**
   - **缓解**：Agent 主动澄清（多轮对话）,引导用户提供更多上下文

---

**领域需求总结:**

本项目作为 AI/ML 应用,其核心竞争力在于 **SQL 生成的 100% 准确性**。这要求：
- ✅ 严格的多层验证机制
- ✅ 完善的测试覆盖和质量监控
- ✅ 明确的错误处理和用户引导
- ✅ 持续的质量改进流程

这些领域要求将指导后续的技术架构设计、功能实现和测试策略。

---

## Web App 特定需求

### 项目类型概述

本系统是一个**单页应用（SPA）**,采用 Vue.js 3 + Element Plus/Ant Design Vue 构建前端,Python 后端提供 RESTful API 服务。

**技术特征:**
- ✅ 前后端分离架构
- ✅ 无页面刷新的流畅用户体验
- ✅ 组件化开发和状态管理（Pinia）
- ✅ 快速响应的交互式界面

### 浏览器支持矩阵

**支持的浏览器（现代浏览器）:**

| 浏览器 | 最低版本 | 说明 |
|-------|---------|------|
| Chrome | 90+ | 推荐,完整支持 |
| Edge | 90+ | 推荐,完整支持 |
| Firefox | 88+ | 完整支持 |
| Safari | 14+ | 完整支持 |

**不支持的浏览器:**
- ❌ Internet Explorer（任何版本）
- ❌ 旧版浏览器（2020年以前的版本）

**理由**：作为内部工具,聚焦于现代浏览器可以使用最新的 Web 技术,减少兼容性问题,提升开发效率。

### 响应式设计

**屏幕尺寸支持:**

1. **桌面端（主要场景）**
   - 最小宽度：1280px
   - 推荐宽度：1920px
   - 布局：双栏布局（文件管理 + 对话界面）

2. **平板端（次要支持）**
   - 宽度范围：768px - 1279px
   - 布局：自适应单栏布局
   - 功能：完整功能

3. **移动端（暂不支持）**
   - MVP 阶段不支持移动端（< 768px）
   - 理由：产品经理和数据分析师主要在桌面端工作

**设计原则:**
- Desktop-first 设计（优先优化桌面体验）
- 关键功能（DDL上传、SQL生成）必须在所有支持的屏幕尺寸上可用

### 性能目标

**页面加载性能:**

| 指标 | 目标值 | 测量方式 |
|-----|-------|---------|
| 首屏加载时间（FCP） | < 1.5秒 | Chrome DevTools Lighthouse |
| 完全可交互时间（TTI） | < 3秒 | Chrome DevTools Lighthouse |
| 首次输入延迟（FID） | < 100ms | 用户实际操作响应时间 |
| 累积布局偏移（CLS） | < 0.1 | 页面稳定性指标 |

**API 响应性能:**

| API | 目标响应时间 | 说明 |
|-----|------------|------|
| DDL 文件上传 | < 1秒 | 文件上传到服务器 |
| DDL 解析 | < 5秒 | 解析并向量化 |
| SQL 生成 | < 3秒 | 自然语言到 SQL |
| 普通对话 | < 2秒 | Agent 对话响应 |

**性能优化策略:**
- ✅ 代码分割（Code Splitting）减少初始加载体积
- ✅ 懒加载（Lazy Loading）非关键组件
- ✅ API 响应缓存（合理场景）
- ✅ 向量检索优化（FAISS/Chroma 内存索引）

### SEO 策略

**SEO 需求：不需要**

**理由:**
- 本系统为企业内部工具,不对外公开
- 用户通过内部链接或书签访问
- 无需搜索引擎索引

**实现方式:**
- 使用标准 Vue Router（Hash 或 History 模式均可）
- 无需 SSR（服务端渲染）
- 无需 Meta 标签优化

### 无障碍访问级别

**目标级别：基本可用（WCAG 2.1 Level A 部分符合）**

**基本要求:**
- ✅ 语义化 HTML 结构（使用正确的标签）
- ✅ 键盘导航支持（Tab 键切换、Enter 确认）
- ✅ 合理的颜色对比度（文本与背景）
- ✅ 表单字段有明确的 Label
- ✅ 按钮和链接有清晰的可点击状态

**不强制要求:**
- ❌ 完整的屏幕阅读器支持
- ❌ WCAG 2.1 Level AA/AAA 认证
- ❌ 详细的 ARIA 标签

**理由**：作为内部工具,优先保证基本可用性,而非严格的无障碍认证。

### 技术架构约束

**前端技术栈:**
- Vue.js 3（Composition API）
- Element Plus 或 Ant Design Vue（UI 组件库）
- Pinia（状态管理）
- Vue Router（路由管理）
- Axios（HTTP 客户端）
- Vite（构建工具）

**后端技术栈:**
- Python 3.9+
- FastAPI 或 Flask（RESTful API 框架）
- LangChain + LangGraph（Agent 框架）
- FAISS/Chroma（向量数据库）
- sqlparse/sqlglot（SQL 解析）

**部署要求:**
- 前端：静态文件部署（Nginx 或 CDN）
- 后端：容器化部署（Docker）
- 向量库：内存运行（无需持久化存储）
- 配置：环境变量管理

### 实施考虑

**开发优先级:**

1. **Phase 1: 核心功能（MVP）**
   - DDL 文件上传和管理界面
   - 智能对话与 SQL 生成界面
   - 桌面端响应式布局
   - 现代浏览器支持

2. **Phase 2: 体验优化（Post-MVP）**
   - 平板端适配
   - 性能优化（代码分割、懒加载）
   - 增强无障碍支持

3. **Phase 3: 扩展功能（未来）**
   - 移动端支持（如有需求）
   - PWA 能力（离线访问）
   - 更多浏览器兼容性

**技术风险与缓解:**

| 风险 | 缓解措施 |
|-----|---------|
| 向量库内存占用过大 | 限制单文件大小（< 10MB）,支持多文件管理 |
| LLM API 调用超时 | 设置合理超时（5秒）,提供重试机制 |
| 前端状态管理复杂 | 使用 Pinia 集中管理,模块化设计 |
| 浏览器兼容性问题 | 使用 Babel 转译,Vite 自动处理 |

---

**Web App 特定需求总结:**

本系统是一个现代化的 SPA 应用,优先服务于桌面端用户（产品经理、数据分析师）,采用前后端分离架构,聚焦于核心功能的高质量实现,而非全面的浏览器兼容性或无障碍认证。

---

## Project Scoping & Phased Development

### MVP Strategy & Philosophy

**MVP 类型：问题解决型 MVP（Problem-Solving MVP）**

**核心问题:**
产品经理不懂 SQL,每次需要数据都要麻烦开发同学,等待时间长（30分钟甚至更久）,心理负担重（不好意思频繁打扰）。

**MVP 验证目标:**
1. **技术可行性验证**：RAG + Agent 架构能否实现 100% 准确的 SQL 生成？
2. **用户价值验证**：产品经理是否真的会使用这个工具来替代找开发？
3. **体验验证**：5分钟内完成数据导出的体验是否足够好？

**MVP 成功标准（3个月验证期）:**
- ✅ 10-20 个产品经理开始使用
- ✅ SQL 生成准确率达到 100%
- ✅ 用户自助完成率 ≥ 80%
- ✅ 开发团队 SQL 请求减少 30%-50%

**资源要求:**
- **团队规模**：1-2 个全栈开发（前端 + 后端 + AI）
- **开发周期**：2-3 个月
- **技能要求**：
  - 前端：Vue.js 3 + Element Plus
  - 后端：Python + FastAPI + LangChain
  - AI：LLM Prompt 工程、RAG 技术、Agent 开发

### MVP Feature Set (Phase 1)

**核心用户旅程支持:**

MVP 聚焦于支持以下 3 个核心旅程:

1. **产品经理 - 首次使用（"Aha!" 时刻）**
   - 上传 DDL 文件 → 快速解析 → 自然语言输入 → 生成精准 SQL → 看到引用来源
   - 目标：90% 首次使用成功率

2. **产品经理 - 日常高频使用**
   - 连续生成多个 SQL,快速响应
   - 目标：每周 ≥ 3 次使用频率

3. **产品经理 - 文件管理**
   - 管理多个 DDL 文件,切换上下文
   - 目标：清晰的文件状态和管理

**Must-Have 核心能力:**

#### 1. DDL 文件管理模块
- ✅ **文件上传**：支持 .sql 格式,拖拽或选择文件
- ✅ **DDL 解析**：提取表结构、字段、索引信息
- ✅ **向量化存储**：使用 FAISS/Chroma 内存向量库
- ✅ **文件列表管理**：显示文件名、解析状态、上传时间
- ✅ **文件操作**：删除、覆盖、切换上下文

**理由**：这是 RAG 技术的基础,没有 DDL 向量化就无法进行语义检索。

#### 2. 智能对话与 SQL 生成模块
- ✅ **双模式交互**：普通对话 + SQL 生成自动切换
- ✅ **Agent 架构**：LLM 自主决策调用向量检索工具
- ✅ **RAG 流程**：自然语言 → 向量检索 → SQL 生成
- ✅ **可解释性**：展示引用的表和字段,建立信任
- ✅ **SQL 复制**：一键复制生成的 SQL

**理由**：这是核心价值所在,解决用户的主要痛点。

#### 3. 基础质量保障
- ✅ **语法验证**：使用 SQL Parser 验证生成的 SQL 语法正确性
- ✅ **引用验证**：确保引用的表和字段确实存在于 DDL 中
- ✅ **错误处理**：DDL 解析失败、SQL 生成失败的友好提示
- ✅ **性能保障**：DDL 解析 < 5秒,SQL 生成 < 3秒

**理由**：100% 准确率要求,必须有验证机制。

### Out of Scope（MVP 明确不包含）

**明确排除的功能（避免范围蔓延）:**

- ❌ **SQL 执行和结果预览**
  - 理由：MVP 聚焦于 SQL 生成,执行交给开发同学
  - 未来：Phase 2 可以添加（需要数据库连接权限）

- ❌ **多用户登录和权限管理**
  - 理由：作为个人工具,MVP 单用户即可
  - 未来：Phase 3 企业级扩展时添加

- ❌ **数据库直连**
  - 理由：安全性考虑,MVP 通过 DDL 文件管理
  - 未来：Phase 3 可以支持

- ❌ **SQL 语法验证（高级）**
  - 理由：MVP 只验证基本语法,不做深度语义分析
  - 未来：Phase 2 增强功能

- ❌ **DDL 关系图可视化**
  - 理由：Nice-to-have,不影响核心价值
  - 未来：Phase 2 增强体验

- ❌ **历史记录和收藏**
  - 理由：MVP 聚焦于当前会话
  - 未来：Phase 2 用户体验优化

**范围控制原则:**
> 如果没有这个功能,用户的核心痛点（生成 SQL）能否解决？如果能,就不放在 MVP。

### Post-MVP Features

#### Phase 2: 功能增强（3-6 个月,MVP 验证成功后）

**目标**：基于 MVP 用户反馈,增强功能和体验

**增强功能:**

1. **SQL 增强功能**
   - SQL 语法高级验证和错误提示
   - SQL 执行和结果预览
   - SQL 执行历史记录

2. **DDL 可视化**
   - DDL 关系图可视化（表之间的关联）
   - 数据字典自动生成
   - 表结构搜索和过滤

3. **多数据库支持**
   - 支持 MySQL, PostgreSQL, Oracle, SQL Server
   - 数据库方言自动适配

4. **用户体验优化**
   - 对话历史记录
   - SQL 收藏和模板
   - 快捷键支持

**适用场景**：50+ 产品经理日常使用,功能需求增多

#### Phase 3: 企业级扩展（6-12 个月）

**目标**：覆盖公司所有产品经理和数据分析岗位

**企业级功能:**

1. **用户与权限管理**
   - 多用户登录和身份认证
   - 基于角色的权限控制（RBAC）
   - 操作审计日志

2. **数据库直连**
   - 直接连接数据库获取 DDL
   - 自动同步表结构变更
   - 支持多数据源管理

3. **高级 Agent 能力**
   - 多轮复杂推理和任务拆解
   - 自动优化查询性能
   - 自动修复常见 SQL 错误

4. **协作功能**
   - SQL 分享和评论
   - 团队知识库
   - 常用查询模板库

**适用场景**：企业级推广,标准化工具

#### Phase 4: 平台化（12+ 个月）

**目标**：从工具到平台,成为数据分析的标准平台

**平台功能:**

1. **数据分析平台**
   - 集成数据可视化功能
   - 支持数据报表自动生成
   - 数据洞察自动发现

2. **生态扩展**
   - 开放 API 供第三方集成
   - 插件机制支持自定义扩展
   - 社区共享 SQL 模板库

**适用场景**：公司级数据平台战略

### Risk Mitigation Strategy

**主要风险与缓解措施:**

#### 1. 技术风险

**风险：100% SQL 准确率难以达成**

| 风险细节 | 缓解措施 | 验证方式 |
|---------|---------|---------|
| LLM 生成不稳定 | 低温度采样（temperature=0.1）+ Few-shot 示例 | 相同输入测试一致性 |
| RAG 召回不准确 | 优化 Embedding 模型、调整 Chunk 策略、提升相关性阈值（≥85%） | 召回率和相关性测试 |
| 复杂查询准确性低 | MVP 限定支持查询复杂度（单表查询、简单 JOIN）,复杂查询 Phase 2 | 按查询类型分类测试 |
| 语法错误 | 使用 SQL Parser（sqlparse/sqlglot）强制验证 | 100% 语法验证覆盖 |

**降级方案**：
- 如果 MVP 阶段无法达到 100% 准确率,可以降级为 95% + 用户审核机制
- 明确标注"AI 生成,请确认后使用"

#### 2. 市场风险

**风险：产品经理不愿意使用（习惯找开发）**

| 风险细节 | 缓解措施 | 验证方式 |
|---------|---------|---------|
| 用户习惯难改变 | 找到"超级用户"（痛点最强的产品经理）先试用 | 观察首批用户留存率 |
| 工具学习成本高 | 首次使用引导、示例查询、友好的错误提示 | 测量"Aha!"时刻触达率 |
| 生成的 SQL 不可信 | 强化可解释性（引用来源）、建立信任 | 用户反馈和满意度调研 |

**验证策略**：
- 前 2 周：找 3-5 个核心用户深度访谈
- 第 1 个月：10-20 人试用,收集反馈
- 第 2-3 个月：迭代优化,提升留存率

#### 3. 资源风险

**风险：开发时间不足或资源受限**

| 风险细节 | 缓解措施 | 验证方式 |
|---------|---------|---------|
| 开发周期超预期 | 严格控制 MVP 范围,坚决不添加 Nice-to-have 功能 | 每周进度检查 |
| 技术难度高于预期 | 提前进行技术预研（RAG、Agent、LangChain） | PoC（概念验证）原型 |
| 团队规模不足 | 优先实现核心功能,UI 可以简化 | MVP 交付物检查 |

**最小可行范围（紧急降级）:**
- 如果资源严重不足,可以进一步简化为：
  - 只支持单文件上传（不支持多文件管理）
  - 只支持简单查询（不支持复杂 JOIN）
  - 界面可以更简化（基础可用即可）

#### 4. 依赖风险

**风险：外部依赖（LLM API、向量库）不稳定**

| 风险细节 | 缓解措施 | 验证方式 |
|---------|---------|---------|
| LLM API 不稳定 | 设置超时（5秒）和重试机制（最多 3 次） | 压力测试 |
| LLM API 成本高 | 使用缓存减少重复调用、优化 Prompt 长度 | 成本监控 |
| 向量库内存占用大 | 限制单文件大小（< 10MB）、支持多文件管理 | 内存监控 |

---

**范围界定总结:**

本项目采用**问题解决型 MVP** 策略,聚焦于验证"产品经理能否通过 RAG 快速生成 SQL"这一核心问题。MVP 严格控制在 3 个核心功能模块（DDL 管理、对话生成、质量保障）,明确排除所有 Nice-to-have 功能。通过 3 个月的验证期,目标是 10-20 个用户使用,SQL 准确率 100%,自助完成率 ≥ 80%。

**关键成功因素:**
- ✅ 严格控制 MVP 范围,不蔓延
- ✅ 100% SQL 准确率的技术保障
- ✅ 快速迭代和用户反馈循环
- ✅ 风险提前识别和缓解预案

---

## Functional Requirements

### 文件管理能力

**FR1**: 用户可以上传 DDL 文件（.sql 格式）

**FR2**: 用户可以通过拖拽或选择文件的方式上传 DDL

**FR3**: 系统可以解析 DDL 文件,提取表结构、字段、索引信息

**FR4**: 系统可以将 DDL 内容向量化并存储到内存向量库

**FR5**: 用户可以查看已上传文件的列表（文件名、状态、上传时间）

**FR6**: 用户可以查看文件的解析状态（已解析、解析中、解析失败、待支持格式）

**FR7**: 用户可以删除已上传的文件

**FR8**: 用户可以覆盖同名文件（系统提示确认）

**FR9**: 用户可以选择当前使用的文件（切换上下文）

**FR10**: 系统可以支持多个文件的独立管理

**FR11**: 系统可以在文件解析完成后显示解析结果（表数量、字段数量）

### 智能对话能力

**FR12**: 用户可以通过自然语言与系统对话

**FR13**: 系统可以识别用户意图（普通对话 vs SQL 生成需求）

**FR14**: 系统可以在普通对话模式下回应用户的一般性问题

**FR15**: 系统可以在识别到 SQL 生成需求时自动切换到 SQL 生成模式

**FR16**: 系统可以在对话界面显示历史对话（当前会话）

**FR17**: 用户可以输入文本并发送消息

### SQL 生成能力

**FR18**: 系统可以基于用户的自然语言描述生成 SQL 语句

**FR19**: 系统可以使用 Agent 架构自主决策是否需要调用向量检索工具

**FR20**: 系统可以根据用户意图检索相关的 DDL 片段（表和字段）

**FR21**: 系统可以将检索到的 DDL 片段作为上下文补充到 LLM Prompt 中

**FR22**: 系统可以生成语法正确的 SQL 语句（符合目标数据库语法）

**FR23**: 系统可以生成逻辑正确的 SQL 语句（完全符合用户意图）

**FR24**: 用户可以一键复制生成的 SQL 语句

**FR25**: 系统可以在 SQL 生成响应时间在 3 秒内完成

### 可解释性能力

**FR26**: 系统可以展示生成 SQL 时引用的表名称

**FR27**: 系统可以展示生成 SQL 时引用的字段名称

**FR28**: 系统可以展示表和字段的中文说明（如果 DDL 中有注释）

**FR29**: 用户可以通过引用信息验证 SQL 的准确性

**FR30**: 系统可以清晰格式化引用信息（表名 + 字段名 + 说明）

### 质量保障能力

**FR31**: 系统可以在生成 SQL 后进行语法验证（使用 SQL Parser）

**FR32**: 系统可以验证引用的表和字段是否存在于当前 DDL 中

**FR33**: 系统可以在 SQL 生成失败时提供友好的错误提示

**FR34**: 系统可以在 DDL 解析失败时提供清晰的错误原因和修正建议

**FR35**: 系统可以在向量检索失败时告知用户而非生成错误的 SQL

**FR36**: 系统可以确保相同的自然语言输入生成一致的 SQL（输出一致性 ≥ 95%）

### 用户引导能力

**FR37**: 系统可以为首次使用的用户提供简单的使用引导

**FR38**: 系统可以在用户上传文件后提供清晰的成功反馈

**FR39**: 系统可以在操作失败时提供明确的失败原因和下一步建议

**FR40**: 系统可以在 DDL 解析过程中显示进度提示

**FR41**: 系统可以在 SQL 生成过程中显示生成状态（如"AI 正在思考..."）

### 系统稳定性能力

**FR42**: 系统可以在 LLM API 调用超时时提供重试机制

**FR43**: 系统可以限制单个 DDL 文件的大小（< 10MB）

**FR44**: 系统可以在内存资源不足时提供清晰的提示

**FR45**: 系统可以在服务不可用时提供友好的降级提示

---

**功能需求总结:**

本系统定义了 **45 条功能需求**,覆盖 **7 个核心能力领域**:

1. **文件管理能力**（FR1-FR11）：支持 DDL 文件的上传、解析、向量化、多文件管理
2. **智能对话能力**（FR12-FR17）：支持自然语言交互和意图识别
3. **SQL 生成能力**（FR18-FR25）：基于 RAG + Agent 架构的智能 SQL 生成
4. **可解释性能力**（FR26-FR30）：展示引用来源,建立用户信任
5. **质量保障能力**（FR31-FR36）：多层验证机制,确保 100% 准确率
6. **用户引导能力**（FR37-FR41）：友好的引导和反馈机制
7. **系统稳定性能力**（FR42-FR45）：错误处理和降级策略

这些功能需求构成了产品的**能力契约**,所有后续的 UX 设计、架构设计和开发实现都将基于这些需求展开。每条 FR 都是可测试的、实现无关的,定义了系统必须具备的能力（WHAT）,而非实现方式（HOW）。

---

## Non-Functional Requirements

### Performance（性能）

**前端性能:**

| 指标 | 目标值 | 理由 |
|-----|-------|------|
| 首屏加载时间（FCP） | < 1.5秒 | 用户快速进入工作状态 |
| 完全可交互时间（TTI） | < 3秒 | 避免用户等待焦虑 |
| 首次输入延迟（FID） | < 100ms | 交互响应流畅 |
| 累积布局偏移（CLS） | < 0.1 | 页面稳定,不抖动 |

**后端性能:**

| 指标 | 目标值 | 理由 |
|-----|-------|------|
| DDL 文件上传 | < 1秒 | 快速反馈 |
| DDL 解析与向量化 | < 5秒 | 用户可接受的等待时间 |
| SQL 生成响应 | < 3秒 | 核心体验,必须快速 |
| 普通对话响应 | < 2秒 | 流畅的对话体验 |
| 向量检索 | < 1秒 | SQL 生成的关键环节 |

**并发性能:**

- MVP 阶段：支持 5-10 个并发用户
- 单用户多会话：支持同一用户同时打开多个标签页

**性能验收标准:**
- ✅ 95% 的请求满足上述性能目标
- ✅ 使用 Chrome DevTools Lighthouse 验证前端性能
- ✅ 使用 APM 工具（如 Prometheus）监控后端性能

### Reliability（可靠性）

**系统可用性:**

| 指标 | 目标值 | 测量方式 |
|-----|-------|---------|
| 系统可用性 | ≥ 99.5% | 月度统计（允许约 3.6 小时停机/月） |
| 错误率 | < 2% | API 请求失败率 |
| MTBF（平均无故障时间） | > 168小时 | 连续运行时间 |
| MTTR（平均修复时间） | < 1小时 | 故障恢复时间 |

**错误处理:**

- ✅ 所有 API 调用必须有超时机制（5秒）
- ✅ 所有 API 调用必须有重试机制（最多 3 次）
- ✅ 所有错误必须有友好的用户提示
- ✅ 所有严重错误必须记录日志供排查

**降级策略:**

- LLM API 不可用：提示用户稍后重试,展示错误信息
- 向量库异常：提示用户重新上传 DDL 文件
- 解析失败：提供清晰的错误原因和修正建议

**备份与恢复:**

- 向量数据：内存运行,无需持久化（重启后重新上传即可）
- 配置文件：版本控制管理
- 日志：保留 7 天

### Quality（质量）

**AI 生成质量（最高优先级）:**

| 指标 | 目标值 | 验证方式 |
|-----|-------|---------|
| SQL 生成准确率 | **100%** | 语法正确 + 逻辑正确 + 可直接执行 |
| 向量检索相关性 | ≥ 85% | 召回的 DDL 片段与意图高度相关 |
| 输出一致性 | ≥ 95% | 相同输入生成一致的 SQL |
| LLM 温度 | 0.1 | 低温度确保输出稳定 |

**质量保障机制:**

1. **多层验证**：
   - 语法验证：使用 SQL Parser（sqlparse/sqlglot）
   - 引用验证：确保引用的表和字段存在于 DDL 中
   - 逻辑验证：Agent 自我验证（ReAct 模式）

2. **测试覆盖**：
   - 单元测试覆盖率 ≥ 80%（核心模块）
   - 集成测试覆盖主要用户旅程
   - E2E 测试覆盖关键路径

3. **代码质量**：
   - 遵循 DDD 分层架构
   - 遵循 SOLID 原则
   - 无明显代码坏味道
   - 代码审查必须通过

### Security（安全）

**数据保护:**

- ✅ DDL 文件内容仅存储在内存,不持久化到磁盘
- ✅ 用户会话数据不跨用户共享
- ✅ LLM API 调用通过 HTTPS 加密传输
- ✅ 敏感配置（API Key）通过环境变量管理,不写入代码

**访问控制:**

- MVP 阶段：单用户模式,无需身份认证
- 未来：Phase 3 增加多用户和权限管理

**SQL 安全:**

- ✅ 防止生成危险的 SQL（DELETE、DROP、UPDATE 无 WHERE 等）
- ✅ SQL 生成前检查语句类型,仅允许 SELECT 查询
- ✅ 未来：Phase 2 可以通过白名单机制扩展支持的 SQL 类型

**日志安全:**

- ✅ 日志中不记录用户的 DDL 文件内容
- ✅ 日志中不记录 LLM API Key
- ✅ 日志中不记录生成的完整 SQL（仅记录摘要）

### Integration（集成）

**外部依赖:**

| 依赖 | 类型 | 可用性要求 | 降级策略 |
|-----|------|-----------|---------|
| LLM API（GLM） | 必需 | ≥ 99% | 超时重试,失败提示用户 |
| 向量库（FAISS/Chroma） | 必需 | 100%（内存） | 内存不足时提示用户 |
| SQL Parser（sqlparse） | 必需 | 100%（本地库） | 无降级,直接报错 |

**API 调用规范:**

- ✅ 所有外部 API 调用设置超时（5秒）
- ✅ 所有外部 API 调用有重试机制（最多 3 次,指数退避）
- ✅ 所有外部 API 调用记录调用时长和成功率

**版本兼容性:**

- LLM API：支持当前主流版本
- Python 版本：3.9+
- Node.js 版本（前端构建）：16+

### Maintainability（可维护性）

**代码可维护性:**

- ✅ 模块化设计：每个模块职责单一
- ✅ 依赖注入：便于测试和替换
- ✅ 配置外部化：所有配置通过环境变量或配置文件
- ✅ 文档完整：关键模块有设计文档和接口说明

**监控与可观测性:**

- ✅ 日志记录：关键操作和错误记录
- ✅ 性能监控：响应时间、错误率统计
- ✅ 资源监控：内存、CPU 使用率
- ✅ 告警机制：关键错误触发告警

**部署与运维:**

- ✅ 容器化部署（Docker）
- ✅ 环境变量管理配置
- ✅ 快速回滚机制（保留上一版本镜像）
- ✅ 健康检查接口（/health）

---

**非功能需求总结:**

本系统的非功能需求聚焦于 **6 个关键质量属性**:

1. **Performance**：前端 < 3秒可交互,SQL 生成 < 3秒
2. **Reliability**：99.5% 可用性,< 2% 错误率
3. **Quality**：100% SQL 准确率（最高优先级）
4. **Security**：基本数据保护和 SQL 安全防护
5. **Integration**：外部依赖的稳定性保障
6. **Maintainability**：可维护性和可观测性

这些 NFR 都是**可测量、可验证**的,将作为系统验收的质量标准。
