import{_ as ke,u as Te,y as x,z as Ve,r as u,m as Ee,A as Ne,c as M,o as p,i as S,a as l,n as xe,b as y,w as o,j as d,d as c,f as m,B as Me,l as De,C as Ue,t as w,D as $e,q as Ae,s as Be,h as k,g as ze,G as le,H as qe,I as Pe,E as v,J as Oe}from"./index-Gyt2orIW.js";import{a as T}from"./index-Bh12ySJS.js";const je={class:"backlog-container"},Ge={key:0,class:"pool-context"},Re={key:0,class:"pool-description"},He={class:"header-content"},Fe={class:"toolbar"},Je={class:"toolbar-left"},Ke={class:"total-count"},Le={class:"toolbar-right"},Qe={key:1,style:{color:"#909399"}},We={key:1,style:{color:"#a0a0a0"}},Xe={key:1,class:"empty-state"},Ye={__name:"Backlog",setup(Ze){const A=Ve(),P=De(),V=Te(),B=x(()=>A.query.poolId?Number(A.query.poolId):null),b=u(!1),O=u(!1),h=u([]),E=u(!1),D=u(!1),j=u(!1),G=u(null),R=u(null),U=u(null),z=u("all"),H=x(()=>j.value),C=x(()=>{var e;const t=((e=V.currentUser)==null?void 0:e.name)||"";return console.log("当前用户:",t),t}),g=u(1),N=u(20),L=u("id"),Q=u("desc"),f=u({title:"",description:""}),oe={title:[{required:!0,message:"请输入标题",trigger:"blur"},{min:2,max:100,message:"标题长度在 2 到 100 个字符",trigger:"blur"}],description:[{required:!0,message:"请输入描述",trigger:"blur"},{min:10,max:500,message:"描述长度在 10 到 500 个字符",trigger:"blur"}]},W=x(()=>z.value==="all"?h.value:h.value.filter(t=>t.status===z.value)),q=x(()=>W.value.length),ae=x(()=>{const t=(g.value-1)*N.value,e=t+N.value;return W.value.slice(t,e)}),se=async()=>{try{const t=await T.getPoolById(B.value);t.code===200&&(U.value=t.data)}catch(t){console.error("加载需求池信息失败:",t),v.error(t.message||"加载需求池信息失败")}},$=async()=>{b.value=!0;try{const t=await T.getPoolStoryCards(B.value);console.log("故事卡列表响应:",t),t.code===200?(h.value=t.data||[],console.log("加载到故事卡:",h.value.length,"张"),console.log("当前用户:",C.value),h.value.forEach((e,s)=>{console.log(`卡片${s+1}: id=${e.id}, title="${e.title}", hostName="${e.hostName}", status=${e.status}`)})):(h.value=[],v.error(t.message||"加载故事卡失败")),g.value>Math.ceil(q.value/N.value)&&(g.value=1)}catch(t){console.error("加载故事卡失败:",t),v.error(t.message||"加载失败，请刷新重试"),h.value=[]}finally{b.value=!1}},ne=t=>{if(!t||!t.hostName)return console.warn("故事卡缺少hostName:",t),!1;if(!C.value)return console.warn("当前用户为空"),!1;const e=t.hostName===C.value;return console.log(`isHost检查: card.hostName="${t.hostName}", currentUser="${C.value}", result=${e}`),e},X=()=>{g.value=1,$()},re=()=>{g.value=1},ue=t=>{g.value=t},ie=t=>{N.value=t,g.value=1},Y=()=>{D.value=!1,j.value=!1,G.value=null,f.value={title:"",description:""},E.value=!0},de=()=>H.value?"查看故事卡详情":D.value?"编辑故事卡":"创建故事卡",ce=t=>{D.value=!0,j.value=!1,G.value=t.id,f.value={title:t.title,description:t.description},E.value=!0},pe=async()=>{R.value&&await R.value.validate(async t=>{var e;if(t){O.value=!0;try{if(D.value)await T.updateStoryCard(G.value,f.value),v.success("更新成功");else{console.log("创建故事卡 - userStore:",V),console.log("创建故事卡 - currentUser:",V.currentUser),console.log("创建故事卡 - 当前用户名:",C.value),console.log("创建故事卡 - poolId:",B.value);let s=C.value;if(s||(s=((e=V.currentUser)==null?void 0:e.name)||""),!s){const r=localStorage.getItem("user");if(r)try{s=JSON.parse(r).name||""}catch(n){console.error("解析用户信息失败:",n)}}s||(s="匿名用户"),console.log("创建故事卡 - 最终使用的用户名:",s),await T.createStoryCard({title:f.value.title,description:f.value.description,poolId:B.value,createdBy:s}),v.success("创建成功，正在刷新列表...")}E.value=!1,await new Promise(s=>setTimeout(s,100)),await $()}catch(s){console.error("操作失败:",s),v.error(s.message||"操作失败")}finally{O.value=!1}}})},ve=async t=>{try{await Oe.confirm(`确定要删除故事卡 "${t.title}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await T.deleteStoryCard(t.id),v.success("删除成功"),$()}catch(e){e!=="cancel"&&console.error("删除失败:",e)}},F=u(null),fe=async t=>{var e,s,r;try{const n=await T.startVotingSession(t.id);console.log("创建会话响应:",n);const i=(e=n.data)==null?void 0:e.id;if(!i){console.error("未获取到 storyCardId，完整响应:",n),v.error("创建会话失败：未获取到会话ID");return}v.success("估点会话已创建");const _=A.query.poolId;P.push({path:`/voting/${i}`,query:_?{poolId:_}:void 0})}catch(n){console.error("创建会话失败:",n),v.error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"创建会话失败")}},me=async t=>{var e,s,r;try{b.value=!0,F.value=t;const n=await T.joinVotingSession(t.id);if(console.log("加入会话响应:",n),n.code===200&&((e=n.data)!=null&&e.id)){const i=n.data.id;v.success("成功加入估点会话！");const _=A.query.poolId;P.push({path:`/voting/${i}`,query:_?{poolId:_}:void 0})}else v.error("加入估点失败")}catch(n){console.error("加入估点失败:",n),v.error(((r=(s=n.response)==null?void 0:s.data)==null?void 0:r.message)||"加入估点失败")}finally{b.value=!1,F.value=null}},ge=t=>({NOT_ESTIMATED:"info",ESTIMATING:"warning",ESTIMATED:"success"})[t]||"info",_e=t=>({NOT_ESTIMATED:"待估点",ESTIMATING:"估点中",ESTIMATED:"已估点"})[t]||t,ye=({row:t})=>t.status==="ESTIMATED"?"row-estimated":t.status==="ESTIMATING"?"row-voting":"";return Ee(async()=>{console.log("Backlog onMounted - userStore:",V),console.log("Backlog onMounted - currentUser:",V.currentUser),console.log("Backlog onMounted - 当前用户名:",C.value),await se(),await $()}),Ne(()=>{$()}),(t,e)=>{const s=c("el-icon"),r=c("el-button"),n=c("el-card"),i=c("el-option"),_=c("el-select"),I=c("el-table-column"),J=c("el-tag"),we=c("el-table"),he=c("el-pagination"),be=c("el-empty"),Z=c("el-input"),ee=c("el-form-item"),Ce=c("el-form"),Ie=c("el-dialog"),Se=Be("loading");return p(),M("div",je,[U.value?(p(),M("div",Ge,[l(r,{onClick:e[0]||(e[0]=a=>m(P).push("/pools")),class:"back-button",size:"large"},{default:o(()=>[l(s,null,{default:o(()=>[l(m(Me))]),_:1}),e[10]||(e[10]=d(" 返回需求池列表 ",-1))]),_:1}),y("h2",null,[l(s,null,{default:o(()=>[l(m(Ue))]),_:1}),d(" "+w(U.value.name),1)]),U.value.description?(p(),M("p",Re,w(U.value.description),1)):S("",!0)])):S("",!0),l(n,{class:"page-header",shadow:"never"},{default:o(()=>[y("div",He,[y("div",null,[y("h2",null,[l(s,null,{default:o(()=>[l(m($e))]),_:1}),e[11]||(e[11]=d(" 故事卡列表",-1))]),e[12]||(e[12]=y("p",{class:"subtitle"},"管理待估点的用户故事",-1))]),l(r,{type:"primary",size:"large",onClick:Y},{default:o(()=>[l(s,null,{default:o(()=>[l(m(Ae))]),_:1}),e[13]||(e[13]=d(" 创建故事卡 ",-1))]),_:1})])]),_:1}),xe((p(),k(n,{class:"story-list"},{default:o(()=>[y("div",Fe,[y("div",Je,[y("span",Ke,"共 "+w(q.value)+" 张故事卡",1)]),y("div",Le,[l(_,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=a=>z.value=a),placeholder:"状态筛选",style:{width:"140px","margin-right":"10px"},onChange:re},{default:o(()=>[l(i,{label:"全部状态",value:"all"}),l(i,{label:"待估点",value:"NOT_ESTIMATED"}),l(i,{label:"估点中",value:"ESTIMATING"}),l(i,{label:"已估点",value:"ESTIMATED"})]),_:1},8,["modelValue"]),l(_,{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=a=>L.value=a),placeholder:"排序字段",style:{width:"140px","margin-right":"10px"},onChange:X},{default:o(()=>[l(i,{label:"按ID排序",value:"id"}),l(i,{label:"按创建时间",value:"createdAt"}),l(i,{label:"按状态排序",value:"status"})]),_:1},8,["modelValue"]),l(_,{modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=a=>Q.value=a),placeholder:"排序方向",style:{width:"120px"},onChange:X},{default:o(()=>[l(i,{label:"降序",value:"desc"}),l(i,{label:"升序",value:"asc"})]),_:1},8,["modelValue"])])]),l(we,{data:ae.value,style:{width:"100%"},"row-class-name":ye},{default:o(()=>[l(I,{prop:"id",label:"ID",width:"80",sortable:""}),l(I,{prop:"title",label:"标题","min-width":"200"}),l(I,{prop:"description",label:"描述","min-width":"300","show-overflow-tooltip":""}),l(I,{label:"状态",width:"120"},{default:o(a=>[l(J,{type:ge(a.row.status)},{default:o(()=>[d(w(_e(a.row.status)),1)]),_:2},1032,["type"])]),_:1}),l(I,{label:"故事点",width:"100"},{default:o(a=>[a.row.storyPoint?(p(),k(J,{key:0,type:"success",effect:"dark"},{default:o(()=>[d(w(a.row.storyPoint)+" 点 ",1)]),_:2},1024)):(p(),M("span",Qe,"-"))]),_:1}),l(I,{label:"主持人",width:"120",align:"center"},{default:o(a=>[ne(a.row)?(p(),k(J,{key:0,type:"success",effect:"dark"},{default:o(()=>[l(s,null,{default:o(()=>[l(m(ze))]),_:1}),d(" "+w(a.row.hostName),1)]),_:2},1024)):(p(),M("span",We,w(a.row.hostName),1))]),_:1}),l(I,{label:"操作",width:"280",fixed:"right"},{default:o(a=>{var te;return[a.row.status==="NOT_ESTIMATED"?(p(),k(r,{key:0,type:"primary",size:"small",onClick:K=>fe(a.row)},{default:o(()=>[l(s,null,{default:o(()=>[l(m(le))]),_:1}),e[14]||(e[14]=d(" 开始估点 ",-1))]),_:1},8,["onClick"])):S("",!0),a.row.status==="ESTIMATING"?(p(),k(r,{key:1,type:"success",size:"small",onClick:K=>me(a.row),loading:b.value&&((te=F.value)==null?void 0:te.id)===a.row.id},{default:o(()=>[l(s,null,{default:o(()=>[l(m(le))]),_:1}),e[15]||(e[15]=d(" 加入估点 ",-1))]),_:1},8,["onClick","loading"])):S("",!0),l(r,{size:"small",onClick:K=>ce(a.row)},{default:o(()=>[l(s,null,{default:o(()=>[l(m(qe))]),_:1}),e[16]||(e[16]=d(" 编辑 ",-1))]),_:1},8,["onClick"]),l(r,{type:"danger",size:"small",onClick:K=>ve(a.row)},{default:o(()=>[l(s,null,{default:o(()=>[l(m(Pe))]),_:1}),e[17]||(e[17]=d(" 删除 ",-1))]),_:1},8,["onClick"])]}),_:1})]),_:1},8,["data"]),q.value>0?(p(),k(he,{key:0,"current-page":g.value,"onUpdate:currentPage":e[4]||(e[4]=a=>g.value=a),"page-size":N.value,"onUpdate:pageSize":e[5]||(e[5]=a=>N.value=a),"page-sizes":[10,20,50,100],total:q.value,layout:"total, sizes, prev, pager, next, jumper",style:{"margin-top":"20px","justify-content":"flex-end"},onSizeChange:ie,onCurrentChange:ue},null,8,["current-page","page-size","total"])):S("",!0),!b.value&&h.value.length===0?(p(),M("div",Xe,[l(be,{description:"暂无故事卡"},{default:o(()=>[l(r,{type:"primary",onClick:Y},{default:o(()=>[...e[18]||(e[18]=[d("创建第一个故事卡",-1)])]),_:1})]),_:1})])):S("",!0)]),_:1})),[[Se,b.value]]),l(Ie,{modelValue:E.value,"onUpdate:modelValue":e[9]||(e[9]=a=>E.value=a),title:de(),width:"600px"},{footer:o(()=>[l(r,{onClick:e[8]||(e[8]=a=>E.value=!1)},{default:o(()=>[d(w(H.value?"关闭":"取消"),1)]),_:1}),H.value?S("",!0):(p(),k(r,{key:0,type:"primary",onClick:pe,loading:O.value},{default:o(()=>[d(w(D.value?"保存":"创建"),1)]),_:1},8,["loading"]))]),default:o(()=>[l(Ce,{model:f.value,rules:oe,ref_key:"formRef",ref:R,"label-width":"80px"},{default:o(()=>[l(ee,{label:"标题",prop:"title"},{default:o(()=>[l(Z,{modelValue:f.value.title,"onUpdate:modelValue":e[6]||(e[6]=a=>f.value.title=a),placeholder:"例如：用户登录功能"},null,8,["modelValue"])]),_:1}),l(ee,{label:"描述",prop:"description"},{default:o(()=>[l(Z,{modelValue:f.value.description,"onUpdate:modelValue":e[7]||(e[7]=a=>f.value.description=a),type:"textarea",rows:4,placeholder:"详细描述用户故事的内容和验收标准"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},lt=ke(Ye,[["__scopeId","data-v-7d59d825"]]);export{lt as default};
