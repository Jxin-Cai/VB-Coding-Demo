---
alwaysApply: false
---
# DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰é¡¹ç›®è§„èŒƒ

> **ä½¿ç”¨åœºæ™¯**ï¼šåœ¨DDDæ¶æ„çš„é¡¹ç›®ä¸­ï¼Œéµå¾ªæ­¤è§„èŒƒç¡®ä¿ä»£ç ç»„ç»‡æ¸…æ™°ã€èŒè´£åˆ†æ˜ã€æ˜“äºç»´æŠ¤ã€‚

---

## ğŸ—ï¸ DDDæ¶æ„åˆ†å±‚

```yaml
ddd_architecture:
  core_principle: "æŒ‰èŒè´£åˆ†å±‚ï¼Œä¾èµ–å€’ç½®ï¼Œé¢†åŸŸå±‚æ˜¯æ ¸å¿ƒ"
  
  layer_structure:
    # ===== å¼€æ”¾ä¸»æœºå±‚ï¼ˆOHS - Open Host Serviceï¼‰=====
    ohs_layer:
      name: "å¼€æ”¾ä¸»æœºå±‚"
      path: "ohs/"
      responsibility: "è¿›ç¨‹é—´äº¤äº’ï¼Œå¯¹å¤–æš´éœ²æ¥å£ç«¯ç‚¹"
      
      sub_layers:
        http:
          path: "ohs/http/"
          purpose: "HTTPç«¯ç‚¹ï¼ˆREST APIï¼‰"
          contains: ["Controller", "DTO", "Request", "Response"]
          
        rpc:
          path: "ohs/rpc/"
          purpose: "RPCç«¯ç‚¹ï¼ˆgRPCã€Dubboç­‰ï¼‰"
          contains: ["RpcService", "Protoå®šä¹‰", "RPC DTO"]
      
      key_rules:
        - "åªèƒ½åŒ…å«æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œä¸èƒ½æœ‰ä¸šåŠ¡é€»è¾‘"
        - "ä¾èµ–åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰è¿›è¡Œèƒ½åŠ›ç¼–æ’"
        - "ä¸èƒ½ç›´æ¥ä¾èµ–é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰"
        - "è´Ÿè´£å‚æ•°æ ¡éªŒã€åè®®è½¬æ¢ã€å¼‚å¸¸å¤„ç†"
    
    # ===== åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰=====
    application_layer:
      name: "åº”ç”¨å±‚"
      path: "application/"
      responsibility: "ç¼–æ’é¢†åŸŸå±‚çš„èƒ½åŠ›ï¼Œæä¾›å¤åˆèƒ½åŠ›"
      
      key_rules:
        - "ç¼–æ’å¤šä¸ªé¢†åŸŸæœåŠ¡å®Œæˆä¸šåŠ¡ç”¨ä¾‹"
        - "ç®¡ç†äº‹åŠ¡è¾¹ç•Œ"
        - "ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼Œä¸šåŠ¡è§„åˆ™åœ¨é¢†åŸŸå±‚"
        - "å¯ä»¥ä¾èµ–é¢†åŸŸå±‚å’ŒåŸºç¡€è®¾æ–½å±‚"
        - "è–„è–„ä¸€å±‚ï¼Œåªåšç¼–æ’ä¸åšè®¡ç®—"
    
    # ===== é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰=====
    domain_layer:
      name: "é¢†åŸŸå±‚"
      path: "domain/"
      responsibility: "è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µã€ä¸šåŠ¡çŠ¶æ€ä¿¡æ¯å’Œä¸šåŠ¡è§„åˆ™ï¼Œæ˜¯æœ€åŸºæœ¬çš„èƒ½åŠ›å•å…ƒ"
      
      structure:
        subdomain:
          path: "domain/{å­åŸŸå}/"
          purpose: "æŒ‰é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†å­åŸŸ"
          
          model:
            path: "domain/{å­åŸŸå}/model/"
            contains: ["å®ä½“ï¼ˆEntityï¼‰", "å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰", "èšåˆæ ¹ï¼ˆAggregate Rootï¼‰"]
            
          repository:
            path: "domain/{å­åŸŸå}/repository/"
            contains: ["ä»“å‚¨æ¥å£ï¼ˆRepository Interfaceï¼‰"]
            note: "åªå®šä¹‰æ¥å£ï¼Œä¸å®ç°"
            
          service:
            path: "domain/{å­åŸŸå}/service/"
            contains: ["é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰"]
            purpose: "æ— æ³•å½’å±äºå•ä¸€å®ä½“/å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘"
      
      key_rules:
        - "ä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚ï¼ˆä¾èµ–å€’ç½®ï¼‰"
        - "åŒ…å«æ ¸å¿ƒä¸šåŠ¡è§„åˆ™å’Œä¸šåŠ¡é€»è¾‘"
        - "å……è¡€æ¨¡å‹ï¼šå®ä½“å’Œå€¼å¯¹è±¡æœ‰æ•°æ®ä¹Ÿæœ‰è¡Œä¸º"
        - "ä»“å‚¨åªå®šä¹‰æ¥å£ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚"
    
    # ===== åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructure Layerï¼‰=====
    infrastructure_layer:
      name: "åŸºç¡€è®¾æ–½å±‚"
      path: "infr/"
      responsibility: "æä¾›æŠ€æœ¯æ”¯æ’‘ï¼Œä¸ä¸šåŠ¡æ— å…³çš„åŸºç¡€ä»£ç "
      
      sub_layers:
        lib:
          path: "infr/lib/"
          purpose: "é€šç”¨å·¥å…·åº“"
          contains: ["å·¥å…·ç±»", "é€šç”¨ç»„ä»¶", "æŠ€æœ¯æ¡†æ¶å°è£…"]
          examples: ["DateUtils", "StringUtils", "JsonUtils", "åŠ å¯†å·¥å…·", "æ–‡ä»¶å¤„ç†å·¥å…·"]
        
        aop:
          path: "infr/aop/"
          purpose: "åˆ‡é¢ç¼–ç¨‹"
          contains: ["æ—¥å¿—åˆ‡é¢", "äº‹åŠ¡åˆ‡é¢", "æƒé™åˆ‡é¢", "æ€§èƒ½ç›‘æ§åˆ‡é¢"]
          examples: ["LogAspect", "PermissionAspect", "PerformanceAspect", "ExceptionHandlerAspect"]
        
        repository_impl:
          path: "infr/repository/"
          purpose: "ä»“å‚¨å®ç°"
          contains: ["Repositoryå®ç°", "Mapper", "æ•°æ®åº“è®¿é—®", "POå¯¹è±¡", "æ‰€æœ‰å¢åˆ æ”¹æŸ¥æ“ä½œ"]
          note: "âš ï¸ ä»“å‚¨å±‚çš„å…¥å‚åªèƒ½æ˜¯é¢†åŸŸæ¨¡å‹æˆ–å…³é”®å­—æ®µï¼ˆå¦‚IDï¼‰ï¼Œè¿”å›å€¼å¿…é¡»æ˜¯é¢†åŸŸæ¨¡å‹"
        
        plugin:
          path: "infr/plugin/"
          purpose: "ä¸­é—´ä»¶é›†æˆä¸é…ç½®"
          contains: ["Redisé…ç½®", "MQé…ç½®", "ESé…ç½®", "ç¼“å­˜é…ç½®", "æ¶ˆæ¯é˜Ÿåˆ—Producer/Consumer"]
          examples: ["RedisConfig", "RabbitMQConfig", "ElasticsearchConfig", "KafkaProducer", "CacheManager"]
        
        client:
          path: "infr/client/"
          purpose: "å¤–éƒ¨ç³»ç»Ÿé›†æˆ"
          contains: ["HTTP Client", "RPC Client", "ç¬¬ä¸‰æ–¹APIå°è£…"]
          examples: ["PaymentClient", "InventoryClient", "UserServiceClient", "ThirdPartyApiClient"]
      
      key_rules:
        - "å®ç°é¢†åŸŸå±‚å®šä¹‰çš„ä»“å‚¨æ¥å£"
        - "å¤„ç†æŠ€æœ¯ç»†èŠ‚ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰"
        - "å¯ä»¥è¢«åº”ç”¨å±‚å’Œé¢†åŸŸå±‚ä¾èµ–"
        - "ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘"
        - "âš ï¸ ä»“å‚¨å±‚çš„å¢åˆ æ”¹æŸ¥åªåœ¨ä»“å‚¨å®ç°ï¼Œé¢†åŸŸæ¨¡å‹åªåŒ…å«ä¸šåŠ¡è¡Œä¸º"
        - "âš ï¸ ä»“å‚¨æ–¹æ³•çš„å…¥å‚åªèƒ½æ˜¯é¢†åŸŸæ¨¡å‹æˆ–å…³é”®å­—æ®µï¼ˆå¦‚IDï¼‰ï¼Œè¿”å›å€¼å¿…é¡»æ˜¯é¢†åŸŸæ¨¡å‹"
```

---

## ğŸ“ åˆ†å±‚èŒè´£è¯¦è§£

### 1ï¸âƒ£ å¼€æ”¾ä¸»æœºå±‚ï¼ˆOHSï¼‰

#### èŒè´£è¯´æ˜

**æ ¸å¿ƒèŒè´£**ï¼šè¿›ç¨‹é—´äº¤äº’çš„è¾¹ç•Œï¼Œå¯¹å¤–æš´éœ²æ¥å£ç«¯ç‚¹

**èƒ½åšä»€ä¹ˆ**ï¼š
- âœ… æ¥æ”¶å¤–éƒ¨è¯·æ±‚ï¼ˆHTTPã€RPCï¼‰
- âœ… å‚æ•°æ ¡éªŒï¼ˆæ ¼å¼ã€å¿…å¡«é¡¹ã€èŒƒå›´ï¼‰
- âœ… åè®®è½¬æ¢ï¼ˆDTO â†” Domain Modelï¼‰
- âœ… è°ƒç”¨åº”ç”¨å±‚æœåŠ¡
- âœ… å¼‚å¸¸æ•è·å’Œè½¬æ¢
- âœ… è¿”å›å“åº”

**ä¸èƒ½åšä»€ä¹ˆ**ï¼š
- âŒ åŒ…å«ä¸šåŠ¡é€»è¾‘
- âŒ ç›´æ¥æ“ä½œæ•°æ®åº“
- âŒ ç›´æ¥è°ƒç”¨é¢†åŸŸæœåŠ¡
- âŒ åŒ…å«ä¸šåŠ¡è§„åˆ™åˆ¤æ–­

#### HTTPç«¯ç‚¹ç¤ºä¾‹

```java
package com.example.ohs.http.quote;

import com.example.application.quote.QuoteApplicationService;
import com.example.ohs.http.quote.dto.CreateQuoteRequest;
import com.example.ohs.http.quote.dto.CreateQuoteResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

/**
 * æŠ¥ä»·å•HTTPæ¥å£
 * 
 * <p>èŒè´£ï¼š
 * <ul>
 *   <li>æ¥æ”¶HTTPè¯·æ±‚</li>
 *   <li>å‚æ•°æ ¡éªŒ</li>
 *   <li>DTOè½¬æ¢</li>
 *   <li>è°ƒç”¨åº”ç”¨å±‚æœåŠ¡</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@RestController
@RequestMapping("/api/quotes")
@RequiredArgsConstructor
@Slf4j
public class QuoteController {
    
    private final QuoteApplicationService quoteApplicationService;
    
    /**
     * åˆ›å»ºæŠ¥ä»·å•
     */
    @PostMapping
    public CreateQuoteResponse createQuote(
        @Validated @RequestBody CreateQuoteRequest request
    ) {
        log.info("æ¥æ”¶åˆ›å»ºæŠ¥ä»·å•è¯·æ±‚ï¼ŒcustomerId: {}", request.getCustomerId());
        
        try {
            // 1. DTOè½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡ï¼ˆé€šè¿‡Converterï¼‰
            CreateQuoteCommand command = QuoteConverter.toCommand(request);
            
            // 2. è°ƒç”¨åº”ç”¨å±‚æœåŠ¡ï¼ˆåªåšç¼–æ’ï¼Œä¸åšä¸šåŠ¡é€»è¾‘ï¼‰
            Quote quote = quoteApplicationService.createQuote(command);
            
            // 3. é¢†åŸŸå¯¹è±¡è½¬æ¢ä¸ºDTO
            CreateQuoteResponse response = QuoteConverter.toResponse(quote);
            
            log.info("æŠ¥ä»·å•åˆ›å»ºæˆåŠŸï¼ŒquoteId: {}", quote.getId());
            return response;
            
        } catch (BusinessException e) {
            log.error("åˆ›å»ºæŠ¥ä»·å•å¤±è´¥ï¼Œä¸šåŠ¡å¼‚å¸¸ï¼š{}", e.getMessage());
            throw new HttpBusinessException(e.getMessage(), e.getErrorCode());
        } catch (Exception e) {
            log.error("åˆ›å»ºæŠ¥ä»·å•å¤±è´¥ï¼Œç³»ç»Ÿå¼‚å¸¸", e);
            throw new HttpSystemException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

#### DTOå®šä¹‰

```java
package com.example.ohs.http.quote.dto;

import lombok.Data;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Positive;
import java.util.List;

/**
 * åˆ›å»ºæŠ¥ä»·å•è¯·æ±‚DTO
 * 
 * <p>æ³¨æ„ï¼š
 * <ul>
 *   <li>DTOåªåŒ…å«æ•°æ®ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘</li>
 *   <li>ä½¿ç”¨æ ¡éªŒæ³¨è§£ç¡®ä¿æ•°æ®åˆæ³•æ€§</li>
 *   <li>ä¸è¦ç›´æ¥æš´éœ²é¢†åŸŸå¯¹è±¡</li>
 * </ul>
 */
@Data
public class CreateQuoteRequest {
    
    /** å®¢æˆ·ID */
    @NotNull(message = "å®¢æˆ·IDä¸èƒ½ä¸ºç©º")
    @Positive(message = "å®¢æˆ·IDå¿…é¡»å¤§äº0")
    private Long customerId;
    
    /** æŠ¥ä»·é¡¹åˆ—è¡¨ */
    @NotNull(message = "æŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º")
    private List<QuoteItemDTO> items;
    
    /** å¤‡æ³¨ */
    private String remark;
}
```

#### RPCç«¯ç‚¹ç¤ºä¾‹

```java
package com.example.ohs.rpc.quote;

import com.example.application.quote.QuoteApplicationService;
import com.example.ohs.rpc.quote.proto.*;
import io.grpc.stub.StreamObserver;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import net.devh.boot.grpc.server.service.GrpcService;

/**
 * æŠ¥ä»·å•gRPCæœåŠ¡
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@GrpcService
@RequiredArgsConstructor
@Slf4j
public class QuoteGrpcService extends QuoteServiceGrpc.QuoteServiceImplBase {
    
    private final QuoteApplicationService quoteApplicationService;
    
    @Override
    public void createQuote(
        CreateQuoteProtoRequest request,
        StreamObserver<CreateQuoteProtoResponse> responseObserver
    ) {
        log.info("æ¥æ”¶gRPCåˆ›å»ºæŠ¥ä»·å•è¯·æ±‚");
        
        try {
            // 1. Protoè½¬æ¢ä¸ºCommand
            CreateQuoteCommand command = ProtoConverter.toCommand(request);
            
            // 2. è°ƒç”¨åº”ç”¨å±‚
            Quote quote = quoteApplicationService.createQuote(command);
            
            // 3. è½¬æ¢ä¸ºProtoå“åº”
            CreateQuoteProtoResponse response = ProtoConverter.toProtoResponse(quote);
            
            responseObserver.onNext(response);
            responseObserver.onCompleted();
            
        } catch (Exception e) {
            log.error("gRPCåˆ›å»ºæŠ¥ä»·å•å¤±è´¥", e);
            responseObserver.onError(e);
        }
    }
}
```

---

### 2ï¸âƒ£ åº”ç”¨å±‚ï¼ˆApplicationï¼‰

#### èŒè´£è¯´æ˜

**æ ¸å¿ƒèŒè´£**ï¼šç¼–æ’é¢†åŸŸå±‚çš„èƒ½åŠ›ï¼Œæä¾›ä¸šåŠ¡ç”¨ä¾‹çš„å®ç°

**èƒ½åšä»€ä¹ˆ**ï¼š
- âœ… ç¼–æ’å¤šä¸ªé¢†åŸŸæœåŠ¡
- âœ… ç®¡ç†äº‹åŠ¡è¾¹ç•Œ
- âœ… åè°ƒèšåˆæ ¹ä¹‹é—´çš„äº¤äº’
- âœ… è°ƒç”¨åŸºç¡€è®¾æ–½å±‚ï¼ˆå‘æ¶ˆæ¯ã€ç¼“å­˜ç­‰ï¼‰
- âœ… å‘å¸ƒé¢†åŸŸäº‹ä»¶

**ä¸èƒ½åšä»€ä¹ˆ**ï¼š
- âŒ åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼ˆä¸šåŠ¡è§„åˆ™åœ¨é¢†åŸŸå±‚ï¼‰
- âŒ ç›´æ¥æ“ä½œæ•°æ®åº“ï¼ˆé€šè¿‡ä»“å‚¨ï¼‰
- âŒ åŒ…å«å¤æ‚è®¡ç®—é€»è¾‘

**è®¾è®¡åŸåˆ™**ï¼šè–„è–„ä¸€å±‚ï¼Œåªåšç¼–æ’ä¸åšè®¡ç®—

#### åº”ç”¨æœåŠ¡ç¤ºä¾‹

```java
package com.example.application.quote;

import com.example.domain.quote.model.Quote;
import com.example.domain.quote.repository.QuoteRepository;
import com.example.domain.quote.service.QuotePricingService;
import com.example.domain.customer.model.Customer;
import com.example.domain.customer.repository.CustomerRepository;
import com.example.infr.event.EventPublisher;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * æŠ¥ä»·å•åº”ç”¨æœåŠ¡
 * 
 * <p><b>èŒè´£</b>ï¼šç¼–æ’é¢†åŸŸèƒ½åŠ›ï¼Œå®Œæˆä¸šåŠ¡ç”¨ä¾‹
 * 
 * <p><b>æ³¨æ„äº‹é¡¹</b>ï¼š
 * <ul>
 *   <li>åªåšç¼–æ’ï¼Œä¸åšè®¡ç®—</li>
 *   <li>ä¸šåŠ¡é€»è¾‘åœ¨é¢†åŸŸå±‚ï¼Œä¸åœ¨åº”ç”¨å±‚</li>
 *   <li>ç®¡ç†äº‹åŠ¡è¾¹ç•Œï¼ˆ@Transactionalï¼‰</li>
 *   <li>åè°ƒå¤šä¸ªèšåˆæ ¹çš„äº¤äº’</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class QuoteApplicationService {
    
    // ========== é¢†åŸŸå±‚ä¾èµ– ==========
    private final QuoteRepository quoteRepository;
    private final CustomerRepository customerRepository;
    private final QuotePricingService quotePricingService;
    
    // ========== åŸºç¡€è®¾æ–½å±‚ä¾èµ– ==========
    private final EventPublisher eventPublisher;
    
    /**
     * åˆ›å»ºæŠ¥ä»·å•ï¼ˆä¸šåŠ¡ç”¨ä¾‹ï¼‰
     * 
     * <p><b>ç¼–æ’æ­¥éª¤</b>ï¼š
     * <ol>
     *   <li>æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯ï¼ˆä»“å‚¨ï¼‰</li>
     *   <li>åˆ›å»ºæŠ¥ä»·å•ï¼ˆèšåˆæ ¹ï¼‰</li>
     *   <li>è®¡ç®—ä»·æ ¼ï¼ˆé¢†åŸŸæœåŠ¡ï¼‰</li>
     *   <li>ä¿å­˜æŠ¥ä»·å•ï¼ˆä»“å‚¨ï¼‰</li>
     *   <li>å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆåŸºç¡€è®¾æ–½ï¼‰</li>
     * </ol>
     */
    @Transactional(rollbackFor = Exception.class)
    public Quote createQuote(CreateQuoteCommand command) {
        log.info("å¼€å§‹åˆ›å»ºæŠ¥ä»·å•ï¼ŒcustomerId: {}", command.getCustomerId());
        
        // ========== æ­¥éª¤1ï¼šæŸ¥è¯¢å®¢æˆ·ä¿¡æ¯ ==========
        // è¯´æ˜ï¼šé€šè¿‡ä»“å‚¨è·å–èšåˆæ ¹
        Customer customer = customerRepository.findById(command.getCustomerId())
            .orElseThrow(() -> new BusinessException("å®¢æˆ·ä¸å­˜åœ¨"));
        
        // ========== æ­¥éª¤2ï¼šåˆ›å»ºæŠ¥ä»·å• ==========
        // è¯´æ˜ï¼šè°ƒç”¨èšåˆæ ¹çš„å·¥å‚æ–¹æ³•ï¼Œä¸šåŠ¡è§„åˆ™åœ¨èšåˆæ ¹å†…éƒ¨
        Quote quote = Quote.create(
            customer,
            command.getItems(),
            command.getRemark()
        );
        
        // ========== æ­¥éª¤3ï¼šè®¡ç®—ä»·æ ¼ ==========
        // è¯´æ˜ï¼šè°ƒç”¨é¢†åŸŸæœåŠ¡å®Œæˆå¤æ‚è®¡ç®—
        quotePricingService.calculatePrice(quote, customer);
        
        // ========== æ­¥éª¤4ï¼šä¿å­˜æŠ¥ä»·å• ==========
        // è¯´æ˜ï¼šé€šè¿‡ä»“å‚¨æŒä¹…åŒ–èšåˆæ ¹
        quoteRepository.save(quote);
        
        // ========== æ­¥éª¤5ï¼šå‘å¸ƒé¢†åŸŸäº‹ä»¶ ==========
        // è¯´æ˜ï¼šé€šçŸ¥å…¶ä»–ä¸Šä¸‹æ–‡
        eventPublisher.publish(new QuoteCreatedEvent(quote.getId(), customer.getId()));
        
        log.info("æŠ¥ä»·å•åˆ›å»ºæˆåŠŸï¼ŒquoteId: {}", quote.getId());
        return quote;
    }
    
    /**
     * æäº¤æŠ¥ä»·å•ï¼ˆä¸šåŠ¡ç”¨ä¾‹ï¼‰
     * 
     * <p><b>ç¼–æ’æ­¥éª¤</b>ï¼š
     * <ol>
     *   <li>æŸ¥è¯¢æŠ¥ä»·å•</li>
     *   <li>æ ¡éªŒå®¢æˆ·ä¿¡ç”¨ï¼ˆåè°ƒå¤šä¸ªèšåˆï¼‰</li>
     *   <li>æäº¤æŠ¥ä»·å•ï¼ˆèšåˆæ ¹çŠ¶æ€å˜æ›´ï¼‰</li>
     *   <li>ä¿å­˜</li>
     *   <li>å‘é€é€šçŸ¥ï¼ˆåŸºç¡€è®¾æ–½ï¼‰</li>
     * </ol>
     */
    @Transactional(rollbackFor = Exception.class)
    public void submitQuote(Long quoteId, Long operatorId) {
        log.info("å¼€å§‹æäº¤æŠ¥ä»·å•ï¼ŒquoteId: {}", quoteId);
        
        // 1. æŸ¥è¯¢æŠ¥ä»·å•
        Quote quote = quoteRepository.findById(quoteId)
            .orElseThrow(() -> new BusinessException("æŠ¥ä»·å•ä¸å­˜åœ¨"));
        
        // 2. æŸ¥è¯¢å®¢æˆ·ï¼ˆè·¨èšåˆåè°ƒï¼‰
        Customer customer = customerRepository.findById(quote.getCustomerId())
            .orElseThrow(() -> new BusinessException("å®¢æˆ·ä¸å­˜åœ¨"));
        
        // 3. æ ¡éªŒå®¢æˆ·ä¿¡ç”¨ï¼ˆé¢†åŸŸæœåŠ¡åè°ƒå¤šä¸ªèšåˆï¼‰
        if (!customer.hasSufficientCredit(quote.getTotalAmount())) {
            throw new BusinessException("å®¢æˆ·ä¿¡ç”¨é¢åº¦ä¸è¶³");
        }
        
        // 4. æäº¤æŠ¥ä»·å•ï¼ˆèšåˆæ ¹çŠ¶æ€å˜æ›´ï¼Œä¸šåŠ¡è§„åˆ™åœ¨èšåˆæ ¹å†…ï¼‰
        quote.submit(operatorId);
        
        // 5. ä¿å­˜
        quoteRepository.save(quote);
        
        // 6. å‘é€é€šçŸ¥ï¼ˆåŸºç¡€è®¾æ–½ï¼‰
        eventPublisher.publish(new QuoteSubmittedEvent(quoteId));
        
        log.info("æŠ¥ä»·å•æäº¤æˆåŠŸ");
    }
}
```

#### Commandå¯¹è±¡

```java
package com.example.application.quote;

import lombok.Builder;
import lombok.Data;
import java.util.List;

/**
 * åˆ›å»ºæŠ¥ä»·å•å‘½ä»¤
 * 
 * <p>Commandå¯¹è±¡ç”¨äºå°è£…åº”ç”¨å±‚çš„è¾“å…¥å‚æ•°
 * <ul>
 *   <li>ä¸å¯å˜å¯¹è±¡ï¼ˆä½¿ç”¨Builderæ¨¡å¼ï¼‰</li>
 *   <li>å‚æ•°å·²åœ¨OHSå±‚æ ¡éªŒ</li>
 *   <li>åŒ…å«ä¸šåŠ¡ç”¨ä¾‹æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯</li>
 * </ul>
 */
@Data
@Builder
public class CreateQuoteCommand {
    
    /** å®¢æˆ·ID */
    private final Long customerId;
    
    /** æŠ¥ä»·é¡¹ */
    private final List<QuoteItemCommand> items;
    
    /** å¤‡æ³¨ */
    private final String remark;
}
```

---

### 3ï¸âƒ£ é¢†åŸŸå±‚ï¼ˆDomainï¼‰

#### èŒè´£è¯´æ˜

**æ ¸å¿ƒèŒè´£**ï¼šè¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µã€ä¸šåŠ¡çŠ¶æ€ã€ä¸šåŠ¡è§„åˆ™

**DDDæ ¸å¿ƒ**ï¼šé¢†åŸŸå±‚æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼ŒåŒ…å«äº†ä¸šåŠ¡çš„æœ¬è´¨

**èƒ½åšä»€ä¹ˆ**ï¼š
- âœ… å®šä¹‰å®ä½“ï¼ˆEntityï¼‰
- âœ… å®šä¹‰å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰
- âœ… å®šä¹‰èšåˆæ ¹ï¼ˆAggregate Rootï¼‰
- âœ… å®ç°ä¸šåŠ¡è§„åˆ™å’Œä¸šåŠ¡é€»è¾‘
- âœ… å®šä¹‰é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰
- âœ… å®šä¹‰ä»“å‚¨æ¥å£ï¼ˆRepository Interfaceï¼‰
- âœ… å‘å¸ƒé¢†åŸŸäº‹ä»¶

**ä¸èƒ½åšä»€ä¹ˆ**ï¼š
- âŒ ä¾èµ–å…¶ä»–å±‚ï¼ˆåº”ç”¨å±‚ã€åŸºç¡€è®¾æ–½å±‚ã€OHSå±‚ï¼‰
- âŒ åŒ…å«æŠ€æœ¯ç»†èŠ‚ï¼ˆæ•°æ®åº“ã€HTTPã€ç¼“å­˜ï¼‰
- âŒ ç›´æ¥æŒä¹…åŒ–æ•°æ®

**è®¾è®¡åŸåˆ™**ï¼šå……è¡€æ¨¡å‹ï¼Œå¯¹è±¡æœ‰æ•°æ®ä¹Ÿæœ‰è¡Œä¸º

#### 3.1 å®ä½“ï¼ˆEntityï¼‰

**å®šä¹‰**ï¼šæœ‰å”¯ä¸€æ ‡è¯†ï¼Œæœ‰ç”Ÿå‘½å‘¨æœŸï¼ŒçŠ¶æ€å¯å˜

```java
package com.example.domain.quote.model;

import com.example.domain.shared.Entity;
import lombok.Getter;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

/**
 * æŠ¥ä»·å•ï¼ˆèšåˆæ ¹ï¼‰
 * 
 * <p><b>èšåˆæ ¹èŒè´£</b>ï¼š
 * <ul>
 *   <li>ç»´æŠ¤èšåˆå†…çš„ä¸€è‡´æ€§è¾¹ç•Œ</li>
 *   <li>å¯¹å¤–æä¾›ä¸šåŠ¡æ“ä½œæ–¹æ³•</li>
 *   <li>åŒ…å«ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸ</li>
 *   <li>ç®¡ç†èšåˆå†…çš„å®ä½“å’Œå€¼å¯¹è±¡</li>
 * </ul>
 * 
 * <p><b>è®¾è®¡åŸåˆ™</b>ï¼š
 * <ul>
 *   <li>å……è¡€æ¨¡å‹ï¼šæœ‰æ•°æ®ä¹Ÿæœ‰è¡Œä¸º</li>
 *   <li>å°è£…ï¼šç§æœ‰å­—æ®µï¼Œé€šè¿‡æ–¹æ³•æ“ä½œ</li>
 *   <li>ä¸å˜æ€§ï¼šä½¿ç”¨finalå­—æ®µï¼Œé¿å…setter</li>
 *   <li>ä¸šåŠ¡æ–¹æ³•ï¼šåæ˜ ä¸šåŠ¡è¯­è¨€</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@Getter
public class Quote implements Entity<Long> {
    
    // ========== èšåˆæ ¹æ ‡è¯† ==========
    /** æŠ¥ä»·å•ID */
    private final Long id;
    
    // ========== åŸºæœ¬å±æ€§ ==========
    /** å®¢æˆ·ID */
    private final Long customerId;
    
    /** æŠ¥ä»·å•çŠ¶æ€ */
    private QuoteStatus status;
    
    /** æŠ¥ä»·é¡¹åˆ—è¡¨ï¼ˆèšåˆå†…çš„å®ä½“ï¼‰ */
    private final List<QuoteItem> items;
    
    /** æ€»é‡‘é¢ */
    private BigDecimal totalAmount;
    
    /** åˆ›å»ºæ—¶é—´ */
    private final LocalDateTime createdTime;
    
    /** æäº¤æ—¶é—´ */
    private LocalDateTime submittedTime;
    
    // ========== æ„é€ å‡½æ•°ï¼ˆç§æœ‰ï¼‰==========
    
    private Quote(Long id, Long customerId, List<QuoteItem> items, BigDecimal totalAmount) {
        this.id = id;
        this.customerId = customerId;
        this.items = new ArrayList<>(items);
        this.totalAmount = totalAmount;
        this.status = QuoteStatus.DRAFT;
        this.createdTime = LocalDateTime.now();
    }
    
    // ========== å·¥å‚æ–¹æ³• ==========
    
    /**
     * åˆ›å»ºæŠ¥ä»·å•ï¼ˆå·¥å‚æ–¹æ³•ï¼‰
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ul>
     *   <li>æŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º</li>
     *   <li>åˆå§‹çŠ¶æ€ä¸ºè‰ç¨¿</li>
     *   <li>æ€»é‡‘é¢åˆå§‹ä¸º0</li>
     * </ul>
     * 
     * @param customer å®¢æˆ·
     * @param itemCommands æŠ¥ä»·é¡¹å‘½ä»¤
     * @param remark å¤‡æ³¨
     * @return æŠ¥ä»·å•
     */
    public static Quote create(
        Customer customer,
        List<QuoteItemCommand> itemCommands,
        String remark
    ) {
        // ä¸šåŠ¡è§„åˆ™ï¼šæŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º
        if (itemCommands == null || itemCommands.isEmpty()) {
            throw new BusinessException("æŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º");
        }
        
        // ä¸šåŠ¡è§„åˆ™ï¼šå®¢æˆ·å¿…é¡»æœ‰æ•ˆ
        if (!customer.isActive()) {
            throw new BusinessException("å®¢æˆ·å·²å¤±æ•ˆï¼Œæ— æ³•åˆ›å»ºæŠ¥ä»·å•");
        }
        
        // åˆ›å»ºæŠ¥ä»·é¡¹
        List<QuoteItem> items = itemCommands.stream()
            .map(cmd -> QuoteItem.create(cmd.getProductId(), cmd.getQuantity()))
            .collect(Collectors.toList());
        
        return new Quote(null, customer.getId(), items, BigDecimal.ZERO);
    }
    
    // ========== ä¸šåŠ¡æ–¹æ³• ==========
    
    /**
     * æäº¤æŠ¥ä»·å•
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ul>
     *   <li>åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥æäº¤</li>
     *   <li>æ€»é‡‘é¢å¿…é¡»å¤§äº0</li>
     *   <li>æŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º</li>
     * </ul>
     * 
     * @param operatorId æ“ä½œäººID
     */
    public void submit(Long operatorId) {
        // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥æäº¤
        if (this.status != QuoteStatus.DRAFT) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€çš„æŠ¥ä»·å•å¯ä»¥æäº¤");
        }
        
        // ä¸šåŠ¡è§„åˆ™ï¼šæ€»é‡‘é¢å¿…é¡»å¤§äº0
        if (this.totalAmount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("æŠ¥ä»·å•æ€»é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        // ä¸šåŠ¡è§„åˆ™ï¼šæŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º
        if (this.items.isEmpty()) {
            throw new BusinessException("æŠ¥ä»·é¡¹ä¸èƒ½ä¸ºç©º");
        }
        
        // çŠ¶æ€å˜æ›´
        this.status = QuoteStatus.SUBMITTED;
        this.submittedTime = LocalDateTime.now();
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆåœ¨èšåˆæ ¹å†…å‘å¸ƒï¼‰
        DomainEventPublisher.publish(new QuoteSubmittedEvent(this.id, operatorId));
    }
    
    /**
     * æ·»åŠ æŠ¥ä»·é¡¹
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ul>
     *   <li>åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥æ·»åŠ </li>
     *   <li>äº§å“ä¸èƒ½é‡å¤</li>
     * </ul>
     */
    public void addItem(QuoteItem item) {
        // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥æ·»åŠ 
        if (this.status != QuoteStatus.DRAFT) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥æ·»åŠ æŠ¥ä»·é¡¹");
        }
        
        // ä¸šåŠ¡è§„åˆ™ï¼šäº§å“ä¸èƒ½é‡å¤
        boolean exists = this.items.stream()
            .anyMatch(i -> i.getProductId().equals(item.getProductId()));
        if (exists) {
            throw new BusinessException("äº§å“å·²å­˜åœ¨ï¼Œä¸èƒ½é‡å¤æ·»åŠ ");
        }
        
        this.items.add(item);
    }
    
    /**
     * åˆ é™¤æŠ¥ä»·é¡¹
     */
    public void removeItem(Long itemId) {
        if (this.status != QuoteStatus.DRAFT) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥åˆ é™¤æŠ¥ä»·é¡¹");
        }
        
        this.items.removeIf(item -> item.getId().equals(itemId));
    }
    
    /**
     * è®¡ç®—æ€»é‡‘é¢ï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰
     * 
     * <p>è¯´æ˜ï¼šç”±é¢†åŸŸæœåŠ¡è°ƒç”¨ï¼Œèšåˆæ ¹è´Ÿè´£ç»´æŠ¤æ€»é‡‘é¢ä¸€è‡´æ€§
     */
    public void calculateTotalAmount() {
        this.totalAmount = this.items.stream()
            .map(QuoteItem::getSubtotal)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    /**
     * åº”ç”¨æŠ˜æ‰£
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ul>
     *   <li>æŠ˜æ‰£ç‡å¿…é¡»åœ¨0-1ä¹‹é—´</li>
     *   <li>åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥åº”ç”¨æŠ˜æ‰£</li>
     * </ul>
     */
    public void applyDiscount(BigDecimal discountRate) {
        // ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
        if (discountRate.compareTo(BigDecimal.ZERO) < 0 
            || discountRate.compareTo(BigDecimal.ONE) > 0) {
            throw new BusinessException("æŠ˜æ‰£ç‡å¿…é¡»åœ¨0-1ä¹‹é—´");
        }
        
        if (this.status != QuoteStatus.DRAFT) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥åº”ç”¨æŠ˜æ‰£");
        }
        
        // å¯¹æ¯ä¸ªæŠ¥ä»·é¡¹åº”ç”¨æŠ˜æ‰£
        this.items.forEach(item -> item.applyDiscount(discountRate));
        
        // é‡æ–°è®¡ç®—æ€»é‡‘é¢
        calculateTotalAmount();
    }
    
    // ========== æŸ¥è¯¢æ–¹æ³• ==========
    
    /**
     * æ˜¯å¦å¯ä»¥ä¿®æ”¹
     */
    public boolean isEditable() {
        return this.status == QuoteStatus.DRAFT;
    }
    
    /**
     * æ˜¯å¦å·²æäº¤
     */
    public boolean isSubmitted() {
        return this.status == QuoteStatus.SUBMITTED 
            || this.status == QuoteStatus.APPROVED
            || this.status == QuoteStatus.REJECTED;
    }
    
    @Override
    public Long getId() {
        return this.id;
    }
}
```

#### 3.2 å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰

**å®šä¹‰**ï¼šæ— å”¯ä¸€æ ‡è¯†ï¼Œä¸å¯å˜ï¼Œé€šè¿‡å±æ€§å€¼åˆ¤æ–­ç›¸ç­‰

```java
package com.example.domain.quote.model;

import lombok.EqualsAndHashCode;
import lombok.Getter;
import java.math.BigDecimal;

/**
 * é‡‘é¢ï¼ˆå€¼å¯¹è±¡ï¼‰
 * 
 * <p><b>å€¼å¯¹è±¡ç‰¹å¾</b>ï¼š
 * <ul>
 *   <li>ä¸å¯å˜ï¼šæ‰€æœ‰å­—æ®µfinalï¼Œæ— setter</li>
 *   <li>é€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰ï¼Œä¸æ˜¯é€šè¿‡ID</li>
 *   <li>æ— å”¯ä¸€æ ‡è¯†</li>
 *   <li>å¯ä»¥è¢«å…±äº«</li>
 * </ul>
 * 
 * <p><b>ä¸šåŠ¡å«ä¹‰</b>ï¼š
 * é‡‘é¢ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè¿˜åŒ…å«å¸ç§ã€ç²¾åº¦ç­‰ä¸šåŠ¡æ¦‚å¿µ
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@Getter
@EqualsAndHashCode  // é€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰
public class Money {
    
    /** é‡‘é¢ */
    private final BigDecimal amount;
    
    /** å¸ç§ */
    private final Currency currency;
    
    // ========== æ„é€ å‡½æ•°ï¼ˆç§æœ‰ï¼‰==========
    
    private Money(BigDecimal amount, Currency currency) {
        // ä¸šåŠ¡è§„åˆ™ï¼šé‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°
        if (amount.compareTo(BigDecimal.ZERO) < 0) {
            throw new IllegalArgumentException("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°");
        }
        
        this.amount = amount;
        this.currency = currency;
    }
    
    // ========== å·¥å‚æ–¹æ³• ==========
    
    /**
     * åˆ›å»ºäººæ°‘å¸é‡‘é¢
     */
    public static Money ofCNY(BigDecimal amount) {
        return new Money(amount, Currency.CNY);
    }
    
    /**
     * åˆ›å»ºç¾å…ƒé‡‘é¢
     */
    public static Money ofUSD(BigDecimal amount) {
        return new Money(amount, Currency.USD);
    }
    
    /**
     * é›¶å…ƒ
     */
    public static Money zero(Currency currency) {
        return new Money(BigDecimal.ZERO, currency);
    }
    
    // ========== ä¸šåŠ¡æ–¹æ³•ï¼ˆè¿”å›æ–°å¯¹è±¡ï¼Œä¸ä¿®æ”¹è‡ªèº«ï¼‰==========
    
    /**
     * åŠ æ³•ï¼ˆè¿”å›æ–°çš„Moneyå¯¹è±¡ï¼‰
     */
    public Money add(Money other) {
        // ä¸šåŠ¡è§„åˆ™ï¼šåªèƒ½ç›¸åŒå¸ç§ç›¸åŠ 
        if (!this.currency.equals(other.currency)) {
            throw new BusinessException("ä¸åŒå¸ç§æ— æ³•ç›¸åŠ ");
        }
        
        return new Money(this.amount.add(other.amount), this.currency);
    }
    
    /**
     * å‡æ³•
     */
    public Money subtract(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new BusinessException("ä¸åŒå¸ç§æ— æ³•ç›¸å‡");
        }
        
        return new Money(this.amount.subtract(other.amount), this.currency);
    }
    
    /**
     * ä¹˜æ³•
     */
    public Money multiply(BigDecimal multiplier) {
        return new Money(this.amount.multiply(multiplier), this.currency);
    }
    
    /**
     * é™¤æ³•
     */
    public Money divide(BigDecimal divisor) {
        if (divisor.compareTo(BigDecimal.ZERO) == 0) {
            throw new IllegalArgumentException("é™¤æ•°ä¸èƒ½ä¸º0");
        }
        
        return new Money(
            this.amount.divide(divisor, 2, BigDecimal.ROUND_HALF_UP), 
            this.currency
        );
    }
    
    /**
     * æ¯”è¾ƒå¤§å°
     */
    public boolean greaterThan(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new BusinessException("ä¸åŒå¸ç§æ— æ³•æ¯”è¾ƒ");
        }
        
        return this.amount.compareTo(other.amount) > 0;
    }
    
    public boolean lessThan(Money other) {
        if (!this.currency.equals(other.currency)) {
            throw new BusinessException("ä¸åŒå¸ç§æ— æ³•æ¯”è¾ƒ");
        }
        
        return this.amount.compareTo(other.amount) < 0;
    }
    
    @Override
    public String toString() {
        return currency.getSymbol() + amount.toString();
    }
}

/**
 * å¸ç§æšä¸¾
 */
enum Currency {
    CNY("Â¥", "äººæ°‘å¸"),
    USD("$", "ç¾å…ƒ"),
    EUR("â‚¬", "æ¬§å…ƒ");
    
    private final String symbol;
    private final String name;
    
    Currency(String symbol, String name) {
        this.symbol = symbol;
        this.name = name;
    }
    
    public String getSymbol() {
        return symbol;
    }
    
    public String getName() {
        return name;
    }
}
```

#### 3.3 é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰

**å®šä¹‰**ï¼šæ— æ³•å½’å±äºå•ä¸€å®ä½“/å€¼å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘

**ä½¿ç”¨åœºæ™¯**ï¼š
- è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
- å¤æ‚çš„ä¸šåŠ¡è§„åˆ™
- éœ€è¦åè°ƒå¤šä¸ªå¯¹è±¡çš„æ“ä½œ

```java
package com.example.domain.quote.service;

import com.example.domain.quote.model.Quote;
import com.example.domain.quote.model.QuoteItem;
import com.example.domain.customer.model.Customer;
import com.example.domain.product.model.Product;
import com.example.domain.product.repository.ProductRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import java.math.BigDecimal;

/**
 * æŠ¥ä»·å•å®šä»·é¢†åŸŸæœåŠ¡
 * 
 * <p><b>é¢†åŸŸæœåŠ¡ç‰¹å¾</b>ï¼š
 * <ul>
 *   <li>æ— çŠ¶æ€ï¼šä¸ä¿å­˜æ•°æ®</li>
 *   <li>åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡</li>
 *   <li>åŒ…å«å¤æ‚ä¸šåŠ¡è§„åˆ™</li>
 *   <li>ä¸å±äºå•ä¸€å®ä½“æˆ–å€¼å¯¹è±¡</li>
 * </ul>
 * 
 * <p><b>ä½•æ—¶ä½¿ç”¨é¢†åŸŸæœåŠ¡</b>ï¼š
 * <ul>
 *   <li>ä¸šåŠ¡æ“ä½œæ¶‰åŠå¤šä¸ªèšåˆ</li>
 *   <li>ä¸šåŠ¡è§„åˆ™æ— æ³•å½’å±äºå•ä¸€å®ä½“</li>
 *   <li>éœ€è¦å¤æ‚çš„è®¡ç®—é€»è¾‘</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@Service
@RequiredArgsConstructor
public class QuotePricingService {
    
    private final ProductRepository productRepository;
    
    /**
     * è®¡ç®—æŠ¥ä»·å•ä»·æ ¼ï¼ˆé¢†åŸŸæœåŠ¡æ–¹æ³•ï¼‰
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ol>
     *   <li>æŸ¥è¯¢æ¯ä¸ªäº§å“çš„ä»·æ ¼</li>
     *   <li>æ ¹æ®å®¢æˆ·ç­‰çº§åº”ç”¨æŠ˜æ‰£</li>
     *   <li>è®¡ç®—æ¯ä¸ªæŠ¥ä»·é¡¹çš„å°è®¡</li>
     *   <li>è®¡ç®—æŠ¥ä»·å•æ€»é‡‘é¢</li>
     * </ol>
     * 
     * <p>è¯´æ˜ï¼š
     * è¿™ä¸ªä¸šåŠ¡é€»è¾‘éœ€è¦åè°ƒQuoteã€QuoteItemã€Customerã€Productå¤šä¸ªå¯¹è±¡ï¼Œ
     * æ— æ³•å½’å±äºå•ä¸€èšåˆï¼Œå› æ­¤æ”¾åœ¨é¢†åŸŸæœåŠ¡ä¸­ã€‚
     * 
     * @param quote æŠ¥ä»·å•èšåˆæ ¹
     * @param customer å®¢æˆ·
     */
    public void calculatePrice(Quote quote, Customer customer) {
        // 1. ä¸ºæ¯ä¸ªæŠ¥ä»·é¡¹è®¡ç®—ä»·æ ¼
        for (QuoteItem item : quote.getItems()) {
            // æŸ¥è¯¢äº§å“ä¿¡æ¯
            Product product = productRepository.findById(item.getProductId())
                .orElseThrow(() -> new BusinessException("äº§å“ä¸å­˜åœ¨"));
            
            // è·å–åŸºç¡€ä»·æ ¼
            BigDecimal basePrice = product.getPrice();
            
            // åº”ç”¨å®¢æˆ·ç­‰çº§æŠ˜æ‰£
            BigDecimal discountRate = customer.getDiscountRate();
            BigDecimal discountedPrice = basePrice.multiply(
                BigDecimal.ONE.subtract(discountRate)
            );
            
            // è®¾ç½®æŠ¥ä»·é¡¹ä»·æ ¼ï¼ˆè°ƒç”¨èšåˆå†…å®ä½“çš„æ–¹æ³•ï¼‰
            item.setPrice(discountedPrice);
        }
        
        // 2. è®¡ç®—æŠ¥ä»·å•æ€»é‡‘é¢ï¼ˆè°ƒç”¨èšåˆæ ¹æ–¹æ³•ï¼‰
        quote.calculateTotalAmount();
    }
    
    /**
     * è®¡ç®—ä¼˜æƒ é‡‘é¢
     * 
     * <p><b>ä¸šåŠ¡è§„åˆ™</b>ï¼š
     * <ul>
     *   <li>VIPå®¢æˆ·äº«å—é¢å¤–ä¼˜æƒ </li>
     *   <li>è®¢å•é‡‘é¢è¶…è¿‡10ä¸‡äº«å—é¢å¤–æŠ˜æ‰£</li>
     * </ul>
     */
    public BigDecimal calculateDiscount(Quote quote, Customer customer) {
        BigDecimal totalAmount = quote.getTotalAmount();
        BigDecimal discount = BigDecimal.ZERO;
        
        // ä¸šåŠ¡è§„åˆ™ï¼šVIPå®¢æˆ·é¢å¤–ä¼˜æƒ 5%
        if (customer.isVip()) {
            discount = discount.add(totalAmount.multiply(new BigDecimal("0.05")));
        }
        
        // ä¸šåŠ¡è§„åˆ™ï¼šè®¢å•é‡‘é¢è¶…è¿‡10ä¸‡é¢å¤–ä¼˜æƒ 3%
        if (totalAmount.compareTo(new BigDecimal("100000")) > 0) {
            discount = discount.add(totalAmount.multiply(new BigDecimal("0.03")));
        }
        
        return discount;
    }
}
```

#### 3.4 ä»“å‚¨æ¥å£ï¼ˆRepository Interfaceï¼‰

**å®šä¹‰**ï¼šé¢†åŸŸå±‚åªå®šä¹‰æ¥å£ï¼Œå®ç°åœ¨åŸºç¡€è®¾æ–½å±‚

**æ ¸å¿ƒåŸåˆ™**ï¼šä¾èµ–å€’ç½®

```java
package com.example.domain.quote.repository;

import com.example.domain.quote.model.Quote;
import java.util.List;
import java.util.Optional;

/**
 * æŠ¥ä»·å•ä»“å‚¨æ¥å£
 * 
 * <p><b>ä»“å‚¨æ¨¡å¼èŒè´£</b>ï¼š
 * <ul>
 *   <li>å°è£…èšåˆæ ¹çš„æŒä¹…åŒ–å’Œé‡å»º</li>
 *   <li>æä¾›é›†åˆè¯­ä¹‰çš„æ¥å£</li>
 *   <li>éšè—æ•°æ®åº“è®¿é—®ç»†èŠ‚</li>
 * </ul>
 * 
 * <p><b>è®¾è®¡åŸåˆ™</b>ï¼š
 * <ul>
 *   <li>é¢†åŸŸå±‚åªå®šä¹‰æ¥å£</li>
 *   <li>åŸºç¡€è®¾æ–½å±‚å®ç°æ¥å£</li>
 *   <li>ä½¿ç”¨é›†åˆè¯­ä¹‰ï¼ˆsaveã€removeï¼‰è€Œéæ•°æ®åº“è¯­ä¹‰ï¼ˆinsertã€deleteï¼‰</li>
 *   <li>ä»¥èšåˆæ ¹ä¸ºå•ä½æ“ä½œ</li>
 * </ul>
 * 
 * <p><b>âš ï¸ æ–¹æ³•ç­¾åè§„èŒƒ</b>ï¼š
 * <ul>
 *   <li>å…¥å‚ï¼šåªèƒ½æ˜¯é¢†åŸŸæ¨¡å‹æˆ–å…³é”®å­—æ®µï¼ˆå¦‚IDï¼‰</li>
 *   <li>è¿”å›å€¼ï¼šå¿…é¡»æ˜¯é¢†åŸŸæ¨¡å‹æˆ–Optional&lt;é¢†åŸŸæ¨¡å‹&gt;</li>
 *   <li>ç¦æ­¢ï¼šå…¥å‚æˆ–è¿”å›å€¼ä½¿ç”¨POã€DTOç­‰éé¢†åŸŸå¯¹è±¡</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
public interface QuoteRepository {
    
    /**
     * ä¿å­˜æŠ¥ä»·å•ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
     * 
     * <p>è¯´æ˜ï¼šä½¿ç”¨é›†åˆè¯­ä¹‰ï¼Œä¸åŒºåˆ†insertå’Œupdate
     */
    Quote save(Quote quote);
    
    /**
     * æ ¹æ®IDæŸ¥è¯¢
     * 
     * <p>è¿”å›ï¼šå®Œæ•´çš„èšåˆæ ¹ï¼ˆåŒ…å«æ‰€æœ‰èšåˆå†…å®ä½“ï¼‰
     */
    Optional<Quote> findById(Long id);
    
    /**
     * æ ¹æ®å®¢æˆ·IDæŸ¥è¯¢æŠ¥ä»·å•åˆ—è¡¨
     */
    List<Quote> findByCustomerId(Long customerId);
    
    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢
     */
    List<Quote> findByStatus(QuoteStatus status);
    
    /**
     * åˆ é™¤æŠ¥ä»·å•
     * 
     * <p>è¯´æ˜ï¼š
     * <ul>
     *   <li>ä½¿ç”¨IDä½œä¸ºå…¥å‚ï¼ˆå…³é”®å­—æ®µï¼‰</li>
     *   <li>ç‰©ç†åˆ é™¤æˆ–é€»è¾‘åˆ é™¤ç”±å®ç°å†³å®š</li>
     * </ul>
     */
    void remove(Long id);
    
    /**
     * æ£€æŸ¥æŠ¥ä»·å•æ˜¯å¦å­˜åœ¨
     */
    boolean existsById(Long id);
}
```

---

### 4ï¸âƒ£ åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰

#### èŒè´£è¯´æ˜

**æ ¸å¿ƒèŒè´£**ï¼šæä¾›æŠ€æœ¯æ”¯æ’‘ï¼Œå®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£

**èƒ½åšä»€ä¹ˆ**ï¼š
- âœ… å®ç°ä»“å‚¨æ¥å£
- âœ… æ•°æ®åº“è®¿é—®ï¼ˆMapperã€JPAï¼‰
- âœ… å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼ˆHTTP Clientã€RPC Clientï¼‰
- âœ… ä¸­é—´ä»¶é›†æˆï¼ˆRedisã€MQã€ESç­‰ï¼‰
- âœ… ç¼“å­˜ç®¡ç†
- âœ… åˆ‡é¢ç¼–ç¨‹ï¼ˆæ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰
- âœ… é€šç”¨å·¥å…·åº“
- âœ… é¢†åŸŸå¯¹è±¡ä¸POçš„è½¬æ¢
- âœ… æ‰€æœ‰æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œ

**ä¸èƒ½åšä»€ä¹ˆ**ï¼š
- âŒ åŒ…å«ä¸šåŠ¡é€»è¾‘
- âŒ ä¿®æ”¹èšåˆæ ¹çš„ä¸šåŠ¡çŠ¶æ€
- âŒ åœ¨ä»“å‚¨æ–¹æ³•ä¸­è¿›è¡Œä¸šåŠ¡è§„åˆ™æ ¡éªŒ

**é‡è¦åŸåˆ™**ï¼š
- âš ï¸ **èŒè´£è¾¹ç•Œ**ï¼šé¢†åŸŸæ¨¡å‹åªåŒ…å«ä¸šåŠ¡è¡Œä¸ºï¼Œä»“å‚¨å±‚å¤„ç†æ‰€æœ‰å­˜å‚¨ç›¸å…³æ“ä½œ
- âš ï¸ **æ–¹æ³•ç­¾å**ï¼šä»“å‚¨æ–¹æ³•çš„å…¥å‚åªèƒ½æ˜¯é¢†åŸŸæ¨¡å‹æˆ–å…³é”®å­—æ®µï¼ˆå¦‚IDï¼‰ï¼Œè¿”å›å€¼å¿…é¡»æ˜¯é¢†åŸŸæ¨¡å‹
- âš ï¸ **æ•°æ®è½¬æ¢**ï¼šä»“å‚¨å±‚è´Ÿè´£é¢†åŸŸå¯¹è±¡å’ŒPOçš„åŒå‘è½¬æ¢ï¼Œé¢†åŸŸå±‚ä¸æ„ŸçŸ¥æ•°æ®åº“ç»“æ„

#### ä»“å‚¨å®ç°ç¤ºä¾‹

```java
package com.example.infr.repository;

import com.example.domain.quote.model.Quote;
import com.example.domain.quote.model.QuoteStatus;
import com.example.domain.quote.repository.QuoteRepository;
import com.example.infr.repository.mapper.QuoteMapper;
import com.example.infr.repository.po.QuotePO;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * æŠ¥ä»·å•ä»“å‚¨å®ç°
 * 
 * <p><b>èŒè´£</b>ï¼š
 * <ul>
 *   <li>å®ç°é¢†åŸŸå±‚å®šä¹‰çš„ä»“å‚¨æ¥å£</li>
 *   <li>é¢†åŸŸå¯¹è±¡ä¸æ•°æ®åº“å¯¹è±¡çš„è½¬æ¢</li>
 *   <li>æ•°æ®åº“è®¿é—®ç»†èŠ‚å°è£…</li>
 * </ul>
 * 
 * @author xinjin
 * @date 2025-10-29
 */
@Repository
@RequiredArgsConstructor
public class QuoteRepositoryImpl implements QuoteRepository {
    
    private final QuoteMapper quoteMapper;
    private final QuoteItemMapper quoteItemMapper;
    
    @Override
    public Quote save(Quote quote) {
        // 1. é¢†åŸŸå¯¹è±¡è½¬æ¢ä¸ºPO
        QuotePO quotePO = QuoteConverter.toPO(quote);
        
        // 2. ä¿å­˜æˆ–æ›´æ–°
        if (quote.getId() == null) {
            quoteMapper.insert(quotePO);
        } else {
            quoteMapper.updateById(quotePO);
        }
        
        // 3. ä¿å­˜æŠ¥ä»·é¡¹ï¼ˆèšåˆå†…çš„å®ä½“ï¼‰
        for (QuoteItem item : quote.getItems()) {
            QuoteItemPO itemPO = QuoteItemConverter.toPO(item, quotePO.getId());
            if (item.getId() == null) {
                quoteItemMapper.insert(itemPO);
            } else {
                quoteItemMapper.updateById(itemPO);
            }
        }
        
        // 4. POè½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡è¿”å›
        return QuoteConverter.toDomain(quotePO, quote.getItems());
    }
    
    @Override
    public Optional<Quote> findById(Long id) {
        // 1. æŸ¥è¯¢ä¸»è¡¨
        QuotePO quotePO = quoteMapper.selectById(id);
        if (quotePO == null) {
            return Optional.empty();
        }
        
        // 2. æŸ¥è¯¢æŠ¥ä»·é¡¹ï¼ˆèšåˆå†…çš„å®ä½“ï¼‰
        List<QuoteItemPO> itemPOs = quoteItemMapper.selectByQuoteId(id);
        List<QuoteItem> items = itemPOs.stream()
            .map(QuoteItemConverter::toDomain)
            .collect(Collectors.toList());
        
        // 3. ç»„è£…å®Œæ•´çš„èšåˆæ ¹
        Quote quote = QuoteConverter.toDomain(quotePO, items);
        
        return Optional.of(quote);
    }
    
    @Override
    public List<Quote> findByCustomerId(Long customerId) {
        List<QuotePO> quotePOs = quoteMapper.selectByCustomerId(customerId);
        
        return quotePOs.stream()
            .map(po -> {
                List<QuoteItemPO> itemPOs = quoteItemMapper.selectByQuoteId(po.getId());
                List<QuoteItem> items = itemPOs.stream()
                    .map(QuoteItemConverter::toDomain)
                    .collect(Collectors.toList());
                return QuoteConverter.toDomain(po, items);
            })
            .collect(Collectors.toList());
    }
    
    @Override
    public List<Quote> findByStatus(QuoteStatus status) {
        List<QuotePO> quotePOs = quoteMapper.selectByStatus(status.name());
        
        return quotePOs.stream()
            .map(po -> {
                List<QuoteItemPO> itemPOs = quoteItemMapper.selectByQuoteId(po.getId());
                List<QuoteItem> items = itemPOs.stream()
                    .map(QuoteItemConverter::toDomain)
                    .collect(Collectors.toList());
                return QuoteConverter.toDomain(po, items);
            })
            .collect(Collectors.toList());
    }
    
    @Override
    public void remove(Long id) {
        // 1. åˆ é™¤æŠ¥ä»·é¡¹
        quoteItemMapper.deleteByQuoteId(id);
        
        // 2. åˆ é™¤ä¸»è¡¨
        quoteMapper.deleteById(id);
    }
    
    @Override
    public boolean existsById(Long id) {
        return quoteMapper.selectById(id) != null;
    }
}
```

#### Mapperç¤ºä¾‹

```java
package com.example.infr.repository.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.example.infr.repository.po.QuotePO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import java.util.List;

/**
 * æŠ¥ä»·å•Mapper
 * 
 * <p>è¯´æ˜ï¼šä½¿ç”¨MyBatis Plusç®€åŒ–CRUDæ“ä½œ
 */
@Mapper
public interface QuoteMapper extends BaseMapper<QuotePO> {
    
    /**
     * æ ¹æ®å®¢æˆ·IDæŸ¥è¯¢
     */
    List<QuotePO> selectByCustomerId(@Param("customerId") Long customerId);
    
    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢
     */
    List<QuotePO> selectByStatus(@Param("status") String status);
}
```

---

## ğŸ”— ä¾èµ–å…³ç³»è§„åˆ™

```yaml
dependency_rules:
  core_principle: "ä¾èµ–å€’ç½®ï¼Œé¢†åŸŸå±‚ä¸ä¾èµ–ä»»ä½•å±‚"
  
  # ===== å…è®¸çš„ä¾èµ–å…³ç³» =====
  allowed_dependencies:
    ohs_layer:
      can_depend_on:
        - "åº”ç”¨å±‚ï¼ˆApplicationï¼‰"
        - "åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰- ä»…å·¥å…·ç±»"
      cannot_depend_on:
        - "é¢†åŸŸå±‚ï¼ˆDomainï¼‰- ä¸èƒ½ç›´æ¥è°ƒç”¨"
    
    application_layer:
      can_depend_on:
        - "é¢†åŸŸå±‚ï¼ˆDomainï¼‰"
        - "åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰"
      cannot_depend_on:
        - "OHSå±‚"
    
    domain_layer:
      can_depend_on:
        - "æ—  - é¢†åŸŸå±‚ä¸ä¾èµ–ä»»ä½•å±‚"
      cannot_depend_on:
        - "æ‰€æœ‰å…¶ä»–å±‚"
      note: "ä¾èµ–å€’ç½®ï¼šé¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼Œå…¶ä»–å±‚å®ç°æ¥å£"
    
    infrastructure_layer:
      can_depend_on:
        - "é¢†åŸŸå±‚ï¼ˆDomainï¼‰- å®ç°é¢†åŸŸæ¥å£"
      cannot_depend_on:
        - "OHSå±‚"
        - "åº”ç”¨å±‚"
      note: "å®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼Œä¸èƒ½åå‘ä¾èµ–"
  
  # ===== ä¾èµ–å…³ç³»å›¾ =====
  dependency_diagram: |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   OHS Layer      â”‚ â† å¯¹å¤–æ¥å£
    â”‚  (HTTP/RPC)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“ ä¾èµ–
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Application      â”‚ â† ç¼–æ’å±‚
    â”‚    Layer         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“ ä¾èµ–
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Domain         â”‚ â† æ ¸å¿ƒå±‚ï¼ˆä¸ä¾èµ–ä»»ä½•å±‚ï¼‰
    â”‚    Layer         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†‘ å®šä¹‰æ¥å£
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Infrastructure   â”‚ â† æŠ€æœ¯æ”¯æ’‘å±‚
    â”‚    Layer         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  # ===== è¿åä¾èµ–è§„åˆ™çš„æ¡ˆä¾‹ =====
  anti_patterns:
    case_1:
      description: "âŒ OHSå±‚ç›´æ¥è°ƒç”¨é¢†åŸŸæœåŠ¡"
      wrong_code: |
        @RestController
        public class QuoteController {
            @Autowired
            private QuotePricingService pricingService;  // âŒ é”™è¯¯
            
            @PostMapping
            public void createQuote() {
                // ç›´æ¥è°ƒç”¨é¢†åŸŸæœåŠ¡
                pricingService.calculatePrice(...);  // âŒ è·³è¿‡åº”ç”¨å±‚
            }
        }
      
      correct_code: |
        @RestController
        public class QuoteController {
            @Autowired
            private QuoteApplicationService applicationService;  // âœ… æ­£ç¡®
            
            @PostMapping
            public void createQuote() {
                // è°ƒç”¨åº”ç”¨å±‚ï¼Œç”±åº”ç”¨å±‚ç¼–æ’é¢†åŸŸæœåŠ¡
                applicationService.createQuote(...);  // âœ… é€šè¿‡åº”ç”¨å±‚
            }
        }
    
    case_2:
      description: "âŒ é¢†åŸŸå±‚ä¾èµ–åŸºç¡€è®¾æ–½å±‚"
      wrong_code: |
        @Service
        public class QuotePricingService {
            @Autowired
            private QuoteMapper quoteMapper;  // âŒ é¢†åŸŸå±‚ä¸èƒ½ä¾èµ–Mapper
            
            public void calculatePrice() {
                Quote quote = quoteMapper.selectById(...);  // âŒ é”™è¯¯
            }
        }
      
      correct_code: |
        @Service
        public class QuotePricingService {
            private final QuoteRepository quoteRepository;  // âœ… ä¾èµ–æ¥å£
            
            public void calculatePrice() {
                Quote quote = quoteRepository.findById(...);  // âœ… é€šè¿‡ä»“å‚¨æ¥å£
            }
        }
    
    case_3:
      description: "âŒ åŸºç¡€è®¾æ–½å±‚åŒ…å«ä¸šåŠ¡é€»è¾‘"
      wrong_code: |
        @Repository
        public class QuoteRepositoryImpl {
            public Quote save(Quote quote) {
                // âŒ åœ¨ä»“å‚¨ä¸­åŒ…å«ä¸šåŠ¡è§„åˆ™
                if (quote.getTotalAmount().compareTo(BigDecimal.ZERO) <= 0) {
                    throw new BusinessException("é‡‘é¢å¿…é¡»å¤§äº0");
                }
                // ...
            }
        }
      
      correct_code: |
        // ä¸šåŠ¡è§„åˆ™åº”åœ¨é¢†åŸŸå±‚
        public class Quote {
            public void submit() {
                // âœ… ä¸šåŠ¡è§„åˆ™åœ¨èšåˆæ ¹ä¸­
                if (this.totalAmount.compareTo(BigDecimal.ZERO) <= 0) {
                    throw new BusinessException("é‡‘é¢å¿…é¡»å¤§äº0");
                }
                // ...
            }
        }
```

---

## ğŸ“› å‘½åè§„èŒƒ

```yaml
naming_conventions:
  # ===== OHSå±‚å‘½å =====
  ohs_layer_naming:
    controller:
      pattern: "{ä¸šåŠ¡å}Controller"
      examples: ["QuoteController", "CustomerController"]
    
    dto:
      request: "{æ“ä½œå}Request"
      response: "{æ“ä½œå}Response"
      examples: ["CreateQuoteRequest", "QueryQuoteResponse"]
    
    rpc_service:
      pattern: "{ä¸šåŠ¡å}GrpcService"
      examples: ["QuoteGrpcService", "OrderGrpcService"]
  
  # ===== åº”ç”¨å±‚å‘½å =====
  application_layer_naming:
    service:
      pattern: "{ä¸šåŠ¡å}ApplicationService"
      examples: ["QuoteApplicationService", "OrderApplicationService"]
    
    command:
      pattern: "{æ“ä½œå}Command"
      examples: ["CreateQuoteCommand", "SubmitOrderCommand"]
  
  # ===== é¢†åŸŸå±‚å‘½å =====
  domain_layer_naming:
    aggregate_root:
      pattern: "{ä¸šåŠ¡æ¦‚å¿µå}"
      examples: ["Quote", "Order", "Customer"]
      note: "ä½¿ç”¨ä¸šåŠ¡è¯­è¨€ï¼Œä¸åŠ åç¼€"
    
    entity:
      pattern: "{ä¸šåŠ¡æ¦‚å¿µå}"
      examples: ["QuoteItem", "OrderLine"]
    
    value_object:
      pattern: "{ä¸šåŠ¡æ¦‚å¿µå}"
      examples: ["Money", "Address", "PhoneNumber"]
    
    domain_service:
      pattern: "{ä¸šåŠ¡å}{åŠ¨ä½œ}Service"
      examples: ["QuotePricingService", "OrderShippingService"]
    
    repository_interface:
      pattern: "{èšåˆæ ¹å}Repository"
      examples: ["QuoteRepository", "OrderRepository"]
    
    domain_event:
      pattern: "{èšåˆæ ¹å}{åŠ¨ä½œè¿‡å»å¼}Event"
      examples: ["QuoteCreatedEvent", "OrderSubmittedEvent"]
  
  # ===== åŸºç¡€è®¾æ–½å±‚å‘½å =====
  infrastructure_layer_naming:
    repository_impl:
      pattern: "{èšåˆæ ¹å}RepositoryImpl"
      examples: ["QuoteRepositoryImpl", "OrderRepositoryImpl"]
    
    mapper:
      pattern: "{å®ä½“å}Mapper"
      examples: ["QuoteMapper", "OrderMapper"]
    
    po:
      pattern: "{å®ä½“å}PO"
      examples: ["QuotePO", "OrderPO"]
      note: "PO = Persistent Object"
    
    client:
      pattern: "{å¤–éƒ¨ç³»ç»Ÿå}Client"
      examples: ["PaymentClient", "InventoryClient"]
```

---

## âœ… è®¾è®¡æ£€æŸ¥æ¸…å•

### åˆ†å±‚æ£€æŸ¥

- [ ] OHSå±‚åªåŒ…å«DTOï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Ÿ
- [ ] åº”ç”¨å±‚åªåšç¼–æ’ï¼Œæ²¡æœ‰ä¸šåŠ¡è§„åˆ™ï¼Ÿ
- [ ] é¢†åŸŸå±‚åŒ…å«æ‰€æœ‰ä¸šåŠ¡è§„åˆ™ï¼Ÿ
- [ ] é¢†åŸŸå±‚ä¸ä¾èµ–å…¶ä»–å±‚ï¼Ÿ
- [ ] åŸºç¡€è®¾æ–½å±‚å®ç°äº†é¢†åŸŸæ¥å£ï¼Ÿ

### èšåˆè®¾è®¡æ£€æŸ¥

- [ ] èšåˆè¾¹ç•Œæ˜¯å¦æ¸…æ™°ï¼Ÿ
- [ ] èšåˆæ ¹æ˜¯å¦ç»´æŠ¤äº†èšåˆå†…çš„ä¸€è‡´æ€§ï¼Ÿ
- [ ] æ˜¯å¦é€šè¿‡èšåˆæ ¹è®¿é—®èšåˆå†…çš„å®ä½“ï¼Ÿ
- [ ] è·¨èšåˆçš„æ“ä½œæ˜¯å¦é€šè¿‡é¢†åŸŸæœåŠ¡æˆ–åº”ç”¨å±‚ï¼Ÿ

### å……è¡€æ¨¡å‹æ£€æŸ¥

- [ ] å®ä½“æ˜¯å¦åŒ…å«ä¸šåŠ¡æ–¹æ³•ï¼Œä¸æ˜¯åªæœ‰getter/setterï¼Ÿ
- [ ] ä¸šåŠ¡è§„åˆ™æ˜¯å¦åœ¨å®ä½“å†…éƒ¨ï¼Œä¸æ˜¯åœ¨Serviceï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨finalå­—æ®µï¼Œé¿å…éšæ„ä¿®æ”¹ï¼Ÿ
- [ ] æ˜¯å¦é€šè¿‡ä¸šåŠ¡æ–¹æ³•ä¿®æ”¹çŠ¶æ€ï¼Œä¸æ˜¯ç›´æ¥setterï¼Ÿ

### ä¾èµ–æ£€æŸ¥

- [ ] ä¾èµ–æ–¹å‘æ˜¯å¦æ­£ç¡®ï¼ˆé¢†åŸŸå±‚ä¸ä¾èµ–ä»»ä½•å±‚ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦ä½¿ç”¨äº†ä¾èµ–å€’ç½®ï¼ˆé¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†å¾ªç¯ä¾èµ–ï¼Ÿ

---

## ğŸ“š å‚è€ƒèµ„æº

- ä¸»æç¤ºè¯ï¼š`.cursor/rules/java_coding_assistant_v2.mdc`
- å®ç°è®¾è®¡æ¨¡æ¿ï¼š`.cursor/rules/implementation_design_template.mdc`
- å•å…ƒæµ‹è¯•è§„èŒƒï¼š`.cursor/rules/unit_test_guidelines.mdc`
- Eric Evansã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹
- Vaughn Vernonã€Šå®ç°é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-10-29
**ç»´æŠ¤è€…**ï¼šxinjin
